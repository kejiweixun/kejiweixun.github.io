<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.c0432cf3a910c922a1c2.css">*{box-sizing:border-box}html{font-size:16px}body,html{min-height:100vh}body{position:relative;margin:0 auto;max-width:800px;padding-bottom:5vh}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:.9em;text-align:left;white-space:pre;word-spacing:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:.4rem .8rem;margin:.2rem 0;overflow:scroll}:not(pre)>code[class*=language-],pre[class*=language-]{background:transparent}:not(pre)>code[class*=language-]{padding:.1rem .4rem;border-radius:.3em;white-space:normal;background:#eee}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.gatsby-highlight{border:1px solid #ccc;border-radius:.3rem}</style><meta name="generator" content="Gatsby 2.23.3"/><title data-react-helmet="true">科技微讯 - 给 gatsby 网站添加评论系统 commento</title><meta data-react-helmet="true" name="description" content="commento 是一款开源评论系统, 这篇文章介绍如何把 commento 部署到自己的服务器, 并添加到 gatsby 等静态博客中."/><link rel="icon" href="/favicon-32x32.png?v=148cfb262ef641558120de298d7bd030"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#DE5E56"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/webpack-runtime-1c379eb5d791a2a8e055.js"/><link as="script" rel="preload" href="/framework-59a9ef51c55d9b62f7de.js"/><link as="script" rel="preload" href="/styles-09367947dddffb36886c.js"/><link as="script" rel="preload" href="/app-b69741a13bfa09202ab5.js"/><link as="script" rel="preload" href="/3dec524e950c0aa58708094517bbdd0d717e6b54-51a8ce17e82345bd5e2f.js"/><link as="script" rel="preload" href="/component---src-template-blog-post-template-js-6a6182f37d130d433ff4.js"/><link as="fetch" rel="preload" href="/page-data/blog/add-commento-to-gatsby/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="j9vm3q">.css-j9vm3q{font-size:1rem;padding:0.3rem 0;border-bottom:3px solid #af6ec3;background-image:url(/static/logo-fbe2a7c09efce730ce95fa3630c1b196.png);background-size:70px;background-repeat:no-repeat;background-position:-25px -20px;}.css-j9vm3q img{width:80px;border-radius:50%;position:absolute;top:-1.8rem;left:-2rem;}.css-j9vm3q ul{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;list-style-type:none;padding-left:3rem;margin:0;}.css-j9vm3q ul li{margin-right:1rem;}.css-j9vm3q a{-webkit-text-decoration:none;text-decoration:none;color:black;font-weight:900;}</style><nav class="css-j9vm3q"><ul><li><a href="/">首页</a></li><li><a href="/about/">关于</a></li></ul></nav><style data-emotion-css="1sacuq3">.css-1sacuq3{width:95%;margin:1rem auto;}</style><main class="css-1sacuq3"><article><header><style data-emotion-css="11ycep3">.css-11ycep3{margin:1rem 0 0.5rem 0;font-size:1.6rem;}</style><h1 class="css-11ycep3">给 gatsby 网站添加评论系统 commento</h1><style data-emotion-css="jt987x">.css-jt987x{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:0.8rem;color:grey;margin-bottom:2rem;}.css-jt987x p:first-of-type{margin-right:1rem;}.css-jt987x a{color:grey;}.css-jt987x a:hover{-webkit-text-decoration:none;text-decoration:none;}</style><address class="css-jt987x"><p>作者: <a href="/about/">科技微讯</a></p><p>日期: <time dateTime="2019/10/24">2019/10/24</time></p></address></header><style data-emotion-css="cpjfn3">.css-cpjfn3{line-height:1.5;margin-bottom:5rem;}.css-cpjfn3 h2{margin-top:2rem;}.css-cpjfn3 h3{margin-top:2.5rem;}.css-cpjfn3 p{text-align:justify;word-break:break-all;}.css-cpjfn3 .task-list-item{list-style-type:none;}.css-cpjfn3 ul{padding-left:0.5rem;list-style-position:inside;}.css-cpjfn3 ul li{margin:0.3rem 0;}.css-cpjfn3 table{margin:2rem auto;border-collapse:collapse;line-height:1.8;}.css-cpjfn3 table td,.css-cpjfn3 table th{border:1px solid black;padding:0 0.4rem;}.css-cpjfn3 table th{background:#ddd;}.css-cpjfn3 blockquote{margin:0;border-left:2px solid grey;}.css-cpjfn3 blockquote p{margin-left:1rem;}.css-cpjfn3 a{color:black;-webkit-text-decoration:underline;text-decoration:underline;}.css-cpjfn3 a:hover{-webkit-text-decoration:none;text-decoration:none;}</style><section class="css-cpjfn3"><h2>都有哪些评论系统</h2>
<p>gatsby 不同于 wordpress, 后者自带评论功能, 前者需要自己搭建评论系统. 我上个月刚刚用 gatsby 重构了 kejiweixun.com, 接着尝试用 staticman 搭建评论系统, 不过 staticman 的使用体验无论对用户还是对博主而言都并不友好.</p>
<p>之所以受部分用户推荐, 主要是它有一个很特别的功能: 用户的评论会作为一个 pull request 提交到你的 github repo, 评论可以自动和文章合并, 成为文章正文的一部分. 于是评论也可以被搜索引擎搜索到, 并且只要你的文章不丢失, 评论就不会丢失. 但我觉得它最大的优点也是它最大的缺点, 这意味着读者评论后不能马上看到自己的评论, 可能会给读者带来疑惑, 这个问题似乎有解决方法, 但我不懂...所以 staticman 被我放弃了.</p>
<p>其实网上有很多评论系统可选择, 主要是通过 js 动态展示在文章底部, 评论和文章正文是分离的, 评论放在一个单独的数据库中. 例如很流行但比较臃肿并且可能会在评论区展示广告的的 Disqus, gatsby 官方还提到了 JustComments, <a href="https://www.talkyard.io/">TalkYard</a>, <a href="https://github.com/gitalk/gitalk">Gitalk</a> 等, 我后来还了解到 <a href="https://github.com/umputun/remark">Remark42</a>, <a href="https://github.com/schn4ck/schnack">schnack</a>, <a href="https://github.com/utterance/utterances">utterances</a>, <a href="https://posativ.org/isso/">Isso</a> 等等, 大多是开源免费的.</p>
<p>我现在用的评论系统是 commento, 也开源, 可以部署在自己的服务器中, 如果你不想自己部署, 可以付费使用商业版本. (20191025 补充: 我已经<a href="https://kejiweixun.com/blog/how-to-deploy-isso-comment-system-gatsby">换成了 isso 评论系统</a>)</p>
<h2>如何用 commento 搭建评论系统</h2>
<p>接下来记录一下怎么部署 commento. 我不是程序员, 所以我选择了比较简单的部署方法: 通过 docker 部署.</p>
<p>上面提到的开源评论系统有一些也提供了 docker 镜像, 有镜像就用镜像, 镜像可比作压缩包, 环境阿/依赖阿/配置阿/什么的都帮你弄好了, 下载下来稍作调整就可以用, 不用自己配置, 可以省很多麻烦.</p>
<p>如果你还不知道 docker 是什么, 可以先看我之前写的两篇文章, 这篇文章不会解释 docker 的基础知识:</p>
<ul>
<li><a href="https://kejiweixun.com/blog/deploy-gatsby-website-with-docker/">如何把 gatsbyjs 网站通过 docker 部署到云服务器</a></li>
<li><a href="https://kejiweixun.com/blog/run-multiple-docker-container-on-one-server/">如何同时运行多个 docker 容器, 并通过不同的域名访问</a></li>
</ul>
<h3>第一步: 运行 commento</h3>
<p>新建文件夹, 比如就叫 test 吧, 在这个文件夹中新建 docker-compose.yml 文件, 参考 commento 的<a href="https://gitlab.com/commento/commento/blob/master/docker-compose.yml">官方文档</a>, 在里面添加以下内容:</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3"</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.gitlab.com/commento/commento
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8080<span class="token punctuation">:</span><span class="token number">8080</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">COMMENTO_ORIGIN</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span> <span class="token comment">#根据实际情况填写</span>
      <span class="token key atrule">COMMENTO_PORT</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">COMMENTO_POSTGRES</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span>//postgres<span class="token punctuation">:</span>postgres@db<span class="token punctuation">:</span>5432/commento<span class="token punctuation">?</span>sslmode=disable
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> db
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> db_network
  <span class="token key atrule">db</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">POSTGRES_DB</span><span class="token punctuation">:</span> commento
      <span class="token key atrule">POSTGRES_USER</span><span class="token punctuation">:</span> postgres <span class="token comment">#根据实际情况填写</span>
      <span class="token key atrule">POSTGRES_PASSWORD</span><span class="token punctuation">:</span> postgres <span class="token comment">#根据实际情况填写</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> db_network
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> postgres_data_volume<span class="token punctuation">:</span>/var/lib/postgresql/data

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">db_network</span><span class="token punctuation">:</span>

<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  postgres_data_volume<span class="token punctuation">:</span></code></pre></div>
<p>其中 <code class="language-text">COMMENTO_ORIGIN</code> 的值需要根据实际情况填写, 因为通常我们都是先在本地电脑运行一次, 确定没问题了, 再部署到服务器, 所以这里填 <code class="language-text">localhost</code>, 部署到服务器后, 我会改成诸如 <code class="language-text">https://xxx.kejiweixun.com</code> 这样的子域名.</p>
<p><code class="language-text">POSTGRES_USER</code> 和 <code class="language-text">POSTGRES_PASSWORD</code> 分别是 commento 用来存储评论的数据库的用户名和密码, 你可以随便改, 但现在只是测试, 所以先用 postgres 吧, <code class="language-text">COMMENTO_POSTGRES</code> 后面的值要和这两个值对应.</p>
<p>接着执行:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">docker-compose up -d</code></pre></div>
<p>第一次执行会从网络下载 commento 和 postgres 这两个镜像, 可能有点慢, 执行完成后, 打开浏览器访问 localhost:8080, 你就能会看到 commento 的登录界面.</p>
<h3>第二步: 把代码添加到网站</h3>
<p>在登录界面注册, 注册成功后登录, 然后点左上角的 New Domain 添加一个新域名, 因为是在本地测试, 所以添加以 localhost 为开头的域名, 至于端口, 如果你的网站在 5000 端口运行, 那就填写 localhost:5000, 如果在 8080 端口运行, 就填 localhost:8080, 以此类推.</p>
<p>然后点击 Install Guide, 把这个界面显示的代码, 如下所示, 添加到你需要显示评论的网站页面中:</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>commento<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://localhost:5000/js/commento.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<p>不同网站有不同的添加方式, 比如用 react 搭建的网站, 包括 gatsby, 你可能要写一个 component, 用 useEffect() 把这两项代码插入网页中.</p>
<p>有些网站可能只要复制粘贴就可以了, 比如在开头创建的 test 文件夹中新建一个 index.html 文件, 在里面添加以下内容:</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>科技微讯<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></div>
<p>这就是一个简单的网站啦! 这个网站添加 commento 评论系统很简单, 复制粘贴即可:</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>科技微讯<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>commento<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://localhost:5080/js/commento.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></div>
<p>然后在 test 文件夹中, 通过命令行工具执行:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">npx serve</code></pre></div>
<p>这时你会看到两个域名, 其中一个往往是 <code class="language-text">http://localhost:5000</code>, 刚才你在 commento 添加的域名要和网站的访问域名一致.</p>
<p>在浏览器访问这个域名, 就可以看到评论系统了:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; color: grey; margin: 0; padding: 0"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 38.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAAnUlEQVQoz52RvQ7CMAyE/fo8C2LIQ0RZurN0YmFkaJ2E5ueIgUoVVRLgpFOkxD7ri0lrDaUUjDFIKUGUc8avWnvIew9mhpxy+a9FznnQ55Raca9GHGME1RpXyTfMbAuFhSsULWSJoG1Oa/LTJbxHQcsSYK1DCKEa2kMWHfUFh9P5hZzek5s42L/nzXbH64xhvH23lN52hdDxhLud8ABWnXbLEumPqQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/aa517cef78792d0f6a97d082be0ea283/ba381/commento1.webp 200w,
/static/aa517cef78792d0f6a97d082be0ea283/7f61c/commento1.webp 400w,
/static/aa517cef78792d0f6a97d082be0ea283/d00b9/commento1.webp 800w,
/static/aa517cef78792d0f6a97d082be0ea283/92f8c/commento1.webp 1200w,
/static/aa517cef78792d0f6a97d082be0ea283/fad48/commento1.webp 1600w,
/static/aa517cef78792d0f6a97d082be0ea283/312c9/commento1.webp 1948w"
          sizes="(max-width: 800px) 100vw, 800px"
          type="image/webp"
        />
        <source
          srcset="/static/aa517cef78792d0f6a97d082be0ea283/772e8/commento1.png 200w,
/static/aa517cef78792d0f6a97d082be0ea283/e17e5/commento1.png 400w,
/static/aa517cef78792d0f6a97d082be0ea283/5a190/commento1.png 800w,
/static/aa517cef78792d0f6a97d082be0ea283/c1b63/commento1.png 1200w,
/static/aa517cef78792d0f6a97d082be0ea283/29007/commento1.png 1600w,
/static/aa517cef78792d0f6a97d082be0ea283/6e52c/commento1.png 1948w"
          sizes="(max-width: 800px) 100vw, 800px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/aa517cef78792d0f6a97d082be0ea283/5a190/commento1.png"
          alt="commento1"
          title="commento1"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<h3>第三步: 部署到服务器</h3>
<p>假设你的服务器 ip 地址是 1.1.1.1, 域名是 kejiweixun.com. 首先你要随便想一个子域名, 例如 commento.kejiweixun.com 等, 并把这个子域名的 dns 指向 1.1.1.1</p>
<p>这里假设你的网站 kejiweixun.com 和评论系统 commento.kejiweixun.com 都部署在 1.1.1.1 这个服务器中, 一个 ip 地址对应两个域名, 这两个域名背后对应不同的程序, 那你需要通过 nginx 之类的工具把流量按照一定的规则转发给 kejiweixun.com 和 commento.kejiweixun.com 处理.</p>
<p>我的做法是, kejiweixun.com 和 commento.kejiweixun.com 都以 docker 部署, 再用 <a href="https://hub.docker.com/r/jwilder/nginx-proxy/dockerfile">jwilder/nginx-proxy</a> 这个 docker 镜像转发流量, 在服务器创建以下 docker-compose.yml 文件:</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.7"</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">kejiweixun.com</span><span class="token punctuation">:</span> <span class="token comment">#镜像 1</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> kejiweixun/kejiweixun.com
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> VIRTUAL_HOST=kejiweixun.com<span class="token punctuation">,</span>www.kejiweixun.com
    <span class="token key atrule">expose</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"80"</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nginx<span class="token punctuation">-</span>proxy
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span> <span class="token comment">#镜像 2</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nginx<span class="token punctuation">-</span>proxy
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"80:80"</span>
      <span class="token punctuation">-</span> <span class="token string">"443:443"</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> data<span class="token punctuation">:</span>/etc/nginx/conf.d
      <span class="token punctuation">-</span> certs<span class="token punctuation">:</span>/etc/nginx/certs
  <span class="token key atrule">dockergen</span><span class="token punctuation">:</span> <span class="token comment">#镜像 3</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> jwilder/docker<span class="token punctuation">-</span>gen
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>gen
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">-</span>notify<span class="token punctuation">-</span>sighup nginx <span class="token punctuation">-</span>watch /etc/docker<span class="token punctuation">-</span>gen/templates/nginx.tmpl /etc/nginx/conf.d/default.conf
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nginx<span class="token punctuation">-</span>proxy
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> certs<span class="token punctuation">:</span>/etc/nginx/certs
      <span class="token punctuation">-</span> data<span class="token punctuation">:</span>/etc/nginx/conf.d
      <span class="token punctuation">-</span> /var/run/docker.sock<span class="token punctuation">:</span>/tmp/docker.sock<span class="token punctuation">:</span>ro
      <span class="token punctuation">-</span> ./nginx.tmpl<span class="token punctuation">:</span>/etc/docker<span class="token punctuation">-</span>gen/templates/nginx.tmpl
  <span class="token key atrule">commento</span><span class="token punctuation">:</span> <span class="token comment">#镜像 4</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.gitlab.com/commento/commento
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> commento
    <span class="token key atrule">expose</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"8080"</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">VIRTUAL_HOST</span><span class="token punctuation">:</span> commento.kejiweixun.com
      <span class="token key atrule">COMMENTO_ORIGIN</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//commento.kejiweixun.com
      <span class="token key atrule">COMMENTO_PORT</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">COMMENTO_POSTGRES</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span>//postgres<span class="token punctuation">:</span>postgres@db<span class="token punctuation">:</span>5432/commento<span class="token punctuation">?</span>sslmode=disable
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> db
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nginx<span class="token punctuation">-</span>proxy
  <span class="token key atrule">db</span><span class="token punctuation">:</span> <span class="token comment">#镜像 5</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> postgres
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">POSTGRES_DB</span><span class="token punctuation">:</span> commento
      <span class="token key atrule">POSTGRES_USER</span><span class="token punctuation">:</span> postgres
      <span class="token key atrule">POSTGRES_PASSWORD</span><span class="token punctuation">:</span> postgres
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nginx<span class="token punctuation">-</span>proxy
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> postgres_data_volume<span class="token punctuation">:</span>/var/lib/postgresql/data
<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">postgres_data_volume</span><span class="token punctuation">:</span>
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">certs</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> local
    <span class="token key atrule">driver_opts</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> none
      <span class="token key atrule">device</span><span class="token punctuation">:</span> home/ubuntu/docker/ssl_certs
      <span class="token key atrule">o</span><span class="token punctuation">:</span> bind
<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">nginx-proxy</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy</code></pre></div>
<p>我在<a href="https://kejiweixun.com/blog/run-multiple-docker-container-on-one-server/">如何同时运行多个 docker 容器, 并通过不同的域名访问</a>对这个文件有详细的解释, 如果你没看懂, 可以先看看这篇文章.</p>
<p>这个文件包括 5 个 docker 镜像, 第一个是 kejiweixun.com 这个博客的镜像, 第二和第三个镜像就是 <a href="https://hub.docker.com/r/jwilder/nginx-proxy/dockerfile">jwilder/nginx-proxy</a>, 第三和第四个就是 commento 了, <code class="language-text">COMMENTO_ORIGIN</code> 已经改成 <code class="language-text">https://commento.kejiweixun.com</code>.</p>
<p>最后执行 <code class="language-text">sudo docker-compose up -d</code>, 这 5 个镜像都会运行起来, 然后访问 <a href="https://commento.kejiweixun.com">https://commento.kejiweixun.com</a> 登录 commento 的后台, 在后台添加 kejiweixun.com 这个域名, 在 kejiweixun.com 的网页代码中, 插入 commento 后台提供的代码, 更新一下 kejiweixun.com 的镜像, 替换旧的 kejiweixun.com, 搞掂!</p>
<h3>第四步: 添加登录方式</h3>
<p>commento 支持匿名评论, 也可以通过 twitter, google, github 三种方式登录后再评论, 我暂时添加了 google 和 github 两种登录方式, 如下所示:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; color: grey; margin: 0; padding: 0"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 46%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABZElEQVQoz21Sy07DMBDs/yLBF1RcOfMFHPkGJFQhDqgnOPE4cUhpaVrHTeJHEjsZdjdJWwqWJruxd8c7u550XQcGL7a+quF8tYdpImxoESkk0Mc63q8HW0lejJHOoviTkXBEYRx0XmJXGGRkk5dnfM6fcHc/w+zhEXlp5Yxj2D/Nn/yuECitkwRJJCS3N3i9vsLZ+QWm00v4Osg5o7Qex+tASD9t2yKEIBWOCVzhNsuhdCFgv6+MKzRy+VuSY/6h8L7Ie8n8yfMCzrk9YUkwziMfpPUXlMh2BVmq3FR9HBFuiwpL5aCK6kC4Wq6gVIaq4kArhGw9Nb1pGtlnsG99g7X2IpcJ/5VsLZGQjLpuhIj7x1A7g69UI/lWgsVaUxtIqrFDD52QtMdDYeZ0nSJJFiTbQ5MslsZ9SjURbg1WqkeyMdhos5/0SPhnyiylHsBvy5O8EKIMqjtG18pejK28vUj+6foBH4i0tRdC2H4AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/5af58d4ae954329733b2ac76b50ecc5a/ba381/commento2.webp 200w,
/static/5af58d4ae954329733b2ac76b50ecc5a/7f61c/commento2.webp 400w,
/static/5af58d4ae954329733b2ac76b50ecc5a/d00b9/commento2.webp 800w,
/static/5af58d4ae954329733b2ac76b50ecc5a/92f8c/commento2.webp 1200w,
/static/5af58d4ae954329733b2ac76b50ecc5a/fad48/commento2.webp 1600w,
/static/5af58d4ae954329733b2ac76b50ecc5a/c01d7/commento2.webp 1704w"
          sizes="(max-width: 800px) 100vw, 800px"
          type="image/webp"
        />
        <source
          srcset="/static/5af58d4ae954329733b2ac76b50ecc5a/772e8/commento2.png 200w,
/static/5af58d4ae954329733b2ac76b50ecc5a/e17e5/commento2.png 400w,
/static/5af58d4ae954329733b2ac76b50ecc5a/5a190/commento2.png 800w,
/static/5af58d4ae954329733b2ac76b50ecc5a/c1b63/commento2.png 1200w,
/static/5af58d4ae954329733b2ac76b50ecc5a/29007/commento2.png 1600w,
/static/5af58d4ae954329733b2ac76b50ecc5a/09b15/commento2.png 1704w"
          sizes="(max-width: 800px) 100vw, 800px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/5af58d4ae954329733b2ac76b50ecc5a/5a190/commento2.png"
          alt="commento2"
          title="commento2"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<p>怎么添加呢? 可以参考<a href="https://docs.commento.io/configuration/backend/">官方文档</a>, 文档告诉我们, 要添加 github 的登录方式, 只要在 docker-compose.yml 文件中添加 <code class="language-text">COMMENTO_GITHUB_KEY</code> 和 <code class="language-text">COMMENTO_GITHUB_SECRET</code> 这两个环境变量就可以啦, google 和 twitter 也有类似的变量, 具体看官方文档. 即:</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token comment">#.....前面省略......</span>
<span class="token key atrule">commento</span><span class="token punctuation">:</span> <span class="token comment">#镜像 4</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.gitlab.com/commento/commento
  <span class="token key atrule">container_name</span><span class="token punctuation">:</span> commento
  <span class="token key atrule">expose</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">"8080"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span>
    <span class="token key atrule">VIRTUAL_HOST</span><span class="token punctuation">:</span> commento.kejiweixun.com
    <span class="token key atrule">COMMENTO_ORIGIN</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//commento.kejiweixun.com
    <span class="token key atrule">COMMENTO_PORT</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">COMMENTO_POSTGRES</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span>//postgres<span class="token punctuation">:</span>postgres@db<span class="token punctuation">:</span>5432/commento<span class="token punctuation">?</span>sslmode=disable
    <span class="token key atrule">COMMENTO_GITHUB_KEY</span><span class="token punctuation">:</span> xxxxxxxxxxxx <span class="token comment">#添加在这里</span>
    <span class="token key atrule">COMMENTO_GITHUB_SECRET</span><span class="token punctuation">:</span> xxxxxxxxxxxx <span class="token comment">#添加在这里</span>
<span class="token comment">#.....后面省略......</span></code></pre></div>
<p>那这两个变量的值怎么获取呢? 去 github 获取, 你需要到 github 创建一个很简单的 oauth 应用. 怎么创建呢? 找到<a href="https://www.freecodecamp.org/news/how-to-setup-worry-free-blog-comments-in-20-simple-steps/">一篇文章</a>, 教你怎么一步一步地创建, 包括 twitter, google 和 github.</p>
<p>更多配置选项请参考官方文档, 有一些还是很有必要开启的, 例如 gzip 压缩等. commento 本身就有反垃圾功能, 不过也可以撘配 Akismet 使用, Akismet 是 wordpress 最常用的反垃圾评论插件, 这个也要通过环境变量开启.</p>
<h3>第五步: 自定义评论系统的外观</h3>
<p>commento 还是挺好看的, 不过我嫌它太占地方了, 尤其是底部的 commento 字样, 不过 commento 允许我们添加自定义样式. 方法是在你前面获取的代码中, 给 <code class="language-text">&lt;script&gt;</code> 元素添加 <code class="language-text">data-css-override</code> 属性, 并把其值指向你自定义的样式表, 例如:</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>commento<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span>
  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://commento.kejiweixun.com/js/commento.js<span class="token punctuation">"</span></span>
  <span class="token attr-name">data-css-override</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://example.com/my-custom-styling.css<span class="token punctuation">"</span></span>
<span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<p>其他配置选项可以继续参考<a href="https://docs.commento.io/configuration/frontend/">官方文档</a>.</p>
<h2>总结</h2>
<p>评论系统终于搞掂啦, 大家评论试试? commento 我不知道自己会用多久, 不想用的时候可以把评论导出为 json 文件, 轻松备份.</p>
<p>20191025 更新: 只用了不到一天, 我已经<a href="https://kejiweixun.com/blog/how-to-deploy-isso-comment-system-gatsby">换成 isso 了</a>.</p></section></article><section id="isso-thread" data-title="给 gatsby 网站添加评论系统 commento" data-isso-id="blog/add-commento-to-gatsby/"></section></main></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-60007929-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/add-commento-to-gatsby/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-b69741a13bfa09202ab5.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-c25716df4fbb2532700a.js"],"component---src-pages-404-js":["/component---src-pages-404-js-c9e1966a23ace7c826bc.js"],"component---src-pages-about-js":["/component---src-pages-about-js-59b4230bb74996afac49.js"],"component---src-pages-apple-features-availability-js":["/component---src-pages-apple-features-availability-js-7187e05c1cd638c24dad.js"],"component---src-pages-index-js":["/component---src-pages-index-js-6b51ff9be05ac468a25d.js"],"component---src-pages-ios-beta-profile-js":["/component---src-pages-ios-beta-profile-js-2136bb473481c848c4ad.js"],"component---src-pages-ios-version-history-js":["/component---src-pages-ios-version-history-js-156ae75be694ec01ebf5.js"],"component---src-template-blog-post-template-js":["/component---src-template-blog-post-template-js-6a6182f37d130d433ff4.js"]};/*]]>*/</script><script src="/component---src-template-blog-post-template-js-6a6182f37d130d433ff4.js" async=""></script><script src="/3dec524e950c0aa58708094517bbdd0d717e6b54-51a8ce17e82345bd5e2f.js" async=""></script><script src="/app-b69741a13bfa09202ab5.js" async=""></script><script src="/styles-09367947dddffb36886c.js" async=""></script><script src="/framework-59a9ef51c55d9b62f7de.js" async=""></script><script src="/webpack-runtime-1c379eb5d791a2a8e055.js" async=""></script></body></html>