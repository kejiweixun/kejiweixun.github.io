<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.3dd06fdc38e97ac2c319.css">*{box-sizing:border-box}html{font-size:16px}body,html{min-height:100vh}body{position:relative;margin:0 auto;max-width:800px;padding-bottom:5vh}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:.9em;text-align:left;white-space:pre;word-spacing:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:.4rem .8rem;margin:.2rem 0;overflow:scroll}:not(pre)>code[class*=language-],pre[class*=language-]{background:transparent}:not(pre)>code[class*=language-]{white-space:normal;background:#eee}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.gatsby-highlight{border:1px solid #ccc;border-radius:.3rem}</style><meta name="generator" content="Gatsby 2.24.32"/><title data-react-helmet="true">科技微讯 - 如何通过 nginx 给 gatsby 网站设置 CSP 等安全性 header</title><meta data-react-helmet="true" name="description" content="科技微讯的博客是用 gatsby.js 生成的静态网站, 部署在 nginx 服务器, 这篇文章分享如何通过修改 nginx 的配置文件, 给 gatsby 网站设置 content security policy 等安全性 HTTP header."/><link rel="icon" href="/favicon-32x32.png?v=fbe2a7c09efce730ce95fa3630c1b196" type="image/png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#DE5E56"/><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/webpack-runtime-fb3a021dbcd73df034de.js"/><link as="script" rel="preload" href="/framework-a38040c4749cf445737f.js"/><link as="script" rel="preload" href="/styles-7573517523cb2796c77b.js"/><link as="script" rel="preload" href="/app-d7aa27b69b62e639b033.js"/><link as="script" rel="preload" href="/9ba78b2a4bb1c73a766a26f9c15557f1bc98f749-4fa9ef365c7ed6c25274.js"/><link as="script" rel="preload" href="/component---src-template-blog-post-template-js-c8fda92863f7ed573f2e.js"/><link as="fetch" rel="preload" href="/page-data/blog/gatsby-content-security-policy/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/static/d/1518281631.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="j9vm3q">.css-j9vm3q{font-size:1rem;padding:0.3rem 0;border-bottom:3px solid #af6ec3;background-image:url(/static/logo-fbe2a7c09efce730ce95fa3630c1b196.png);background-size:70px;background-repeat:no-repeat;background-position:-25px -20px;}.css-j9vm3q img{width:80px;border-radius:50%;position:absolute;top:-1.8rem;left:-2rem;}.css-j9vm3q ul{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;list-style-type:none;padding-left:3rem;margin:0;}.css-j9vm3q ul li{margin-right:1rem;}.css-j9vm3q a{-webkit-text-decoration:none;text-decoration:none;color:black;font-weight:900;}</style><nav class="css-j9vm3q"><ul><li><a href="/">首页</a></li><li><a href="/about/">关于</a></li></ul></nav><style data-emotion-css="1sacuq3">.css-1sacuq3{width:95%;margin:1rem auto;}</style><main class="css-1sacuq3"><article><header><style data-emotion-css="11ycep3">.css-11ycep3{margin:1rem 0 0.5rem 0;font-size:1.6rem;}</style><h1 class="css-11ycep3">如何通过 nginx 给 gatsby 网站设置 CSP 等安全性 header</h1><style data-emotion-css="jt987x">.css-jt987x{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:0.8rem;color:grey;margin-bottom:2rem;}.css-jt987x p:first-of-type{margin-right:1rem;}.css-jt987x a{color:grey;}.css-jt987x a:hover{-webkit-text-decoration:none;text-decoration:none;}</style><address class="css-jt987x"><p>作者: <a href="/about/">科技微讯</a></p><p>日期: <time dateTime="2019/11/12">2019/11/12</time></p></address></header><style data-emotion-css="cpjfn3">.css-cpjfn3{line-height:1.5;margin-bottom:5rem;}.css-cpjfn3 h2{margin-top:2rem;}.css-cpjfn3 h3{margin-top:2.5rem;}.css-cpjfn3 p{text-align:justify;word-break:break-all;}.css-cpjfn3 .task-list-item{list-style-type:none;}.css-cpjfn3 ul{padding-left:0.5rem;list-style-position:inside;}.css-cpjfn3 ul li{margin:0.3rem 0;}.css-cpjfn3 table{margin:2rem auto;border-collapse:collapse;line-height:1.8;}.css-cpjfn3 table td,.css-cpjfn3 table th{border:1px solid black;padding:0 0.4rem;}.css-cpjfn3 table th{background:#ddd;}.css-cpjfn3 blockquote{margin:0;border-left:2px solid grey;}.css-cpjfn3 blockquote p{margin-left:1rem;}.css-cpjfn3 a{color:black;-webkit-text-decoration:underline;text-decoration:underline;}.css-cpjfn3 a:hover{-webkit-text-decoration:none;text-decoration:none;}</style><section class="css-cpjfn3"><h2>nginx 配置 header</h2>
<p>HTTP Header 有一大类叫 security header, 即专门用来提高网站安全性的 header, 都是 response header. 你可以使用 <a href="https://observatory.mozilla.org/">mozilla observatory</a> 或 <a href="https://securityheaders.com/">security headers</a> 检测自己网站的 header 有哪些需要改善的地方.</p>
<p>安全性 header 主要有以下几个, <a href="https://kejiweixun.com">kejiweixun.com</a> 已经设置了除 feature policy 之外的五个:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; color: grey; margin: 0; padding: 0"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 21.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAA4UlEQVQI123NTU6DQBwFcA7nVXTpAbr0ACZdGJMm1TTs6MoNibVatDUK0hAkDJogzlCspbRlIHy2wF9atia/vNV7eYxhhwhTRKj2vUY2JX7VsGlJ/BJviv+UTYcZ6oNW/5iT2CiHmUu9IAszWIXg+kBjyEpIK0gKSHd7ySHjHIK0qjEd4fzk+ujs5jTeAp57P16QFiCZKjfp88rg+V2Q5Lu3D0m0lFdTli31xZSNuVUf7MdTrHSf2iPjIdoC+V0vaZIVMNLHl7ft7uPVPd9T2Qukici1kfP1uSC6Y+LVshn/AWDr0I+ayaVlAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/3eabd395b12ed251c7c258cbeb6a93dc/ba381/security-headers.webp 200w,
/static/3eabd395b12ed251c7c258cbeb6a93dc/7f61c/security-headers.webp 400w,
/static/3eabd395b12ed251c7c258cbeb6a93dc/d00b9/security-headers.webp 800w,
/static/3eabd395b12ed251c7c258cbeb6a93dc/92f8c/security-headers.webp 1200w,
/static/3eabd395b12ed251c7c258cbeb6a93dc/fad48/security-headers.webp 1600w,
/static/3eabd395b12ed251c7c258cbeb6a93dc/57b3a/security-headers.webp 2376w"
          sizes="(max-width: 800px) 100vw, 800px"
          type="image/webp"
        />
        <source
          srcset="/static/3eabd395b12ed251c7c258cbeb6a93dc/772e8/security-headers.png 200w,
/static/3eabd395b12ed251c7c258cbeb6a93dc/e17e5/security-headers.png 400w,
/static/3eabd395b12ed251c7c258cbeb6a93dc/5a190/security-headers.png 800w,
/static/3eabd395b12ed251c7c258cbeb6a93dc/c1b63/security-headers.png 1200w,
/static/3eabd395b12ed251c7c258cbeb6a93dc/29007/security-headers.png 1600w,
/static/3eabd395b12ed251c7c258cbeb6a93dc/59058/security-headers.png 2376w"
          sizes="(max-width: 800px) 100vw, 800px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/3eabd395b12ed251c7c258cbeb6a93dc/5a190/security-headers.png"
          alt="security headers"
          title="security headers"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<p>kejiweixun.com 是用 gatsby.js 生成的静态网站, 用 nginx 作为 web server, 使用腾讯云 CDN 提高网站访问速度, nginx 和 CDN 都可以对 response header 进行设置.</p>
<p>这篇文章主要讨论如何在 nginx 设置这些安全性 header, 会顺带分享如何在 CDN 进行相对应的设置.</p>
<h3>nginx.conf</h3>
<p>在 nginx 设置, 其实就是修改 nginx 的配置文件, github 的 <a href="https://github.com/h5bp/server-configs-nginx">h5bp/server-configs-nginx</a> 很有参考价值, 根据这个 repo, 我把我的 nginx.conf 配置文件修改为:</p>
<div class="gatsby-highlight" data-language="nginx"><pre class="language-nginx"><code class="language-nginx"><span class="token operator">/</span><span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf文件

<span class="token keyword">user</span> nginx<span class="token punctuation">;</span>	
<span class="token keyword">worker_processes</span>  auto<span class="token punctuation">;</span>	

<span class="token keyword">error_log</span>  <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>error<span class="token punctuation">.</span>log warn<span class="token punctuation">;</span>	
<span class="token keyword">pid</span>        <span class="token operator">/</span>var<span class="token operator">/</span>run<span class="token operator">/</span>nginx<span class="token punctuation">.</span><span class="token keyword">pid</span><span class="token punctuation">;</span>	

<span class="token keyword">events</span> <span class="token punctuation">{</span>	
    <span class="token keyword">worker_connections</span>  <span class="token number">1024</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>	

<span class="token keyword">http</span> <span class="token punctuation">{</span>	
    <span class="token keyword">server_tokens</span> off<span class="token punctuation">;</span>
    <span class="token keyword">include</span>       <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span>	
    <span class="token keyword">default_type</span>  application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span>	

    <span class="token keyword">log_format</span>  main  <span class="token string">'$remote_addr - $remote_user [$time_local] "$request" '</span>	
                      <span class="token string">'$status $body_bytes_sent "$http_referer" '</span>	
                      <span class="token string">'"$http_user_agent" "$http_x_forwarded_for"'</span><span class="token punctuation">;</span>	

    <span class="token keyword">access_log</span>  <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>access<span class="token punctuation">.</span>log  main<span class="token punctuation">;</span>	

    <span class="token keyword">sendfile</span>        on<span class="token punctuation">;</span>	
    <span class="token keyword">tcp_nopush</span>      on<span class="token punctuation">;</span>	

    <span class="token keyword">keepalive_timeout</span>  <span class="token number">65</span>s<span class="token punctuation">;</span>	

    <span class="token keyword">gzip</span>  on<span class="token punctuation">;</span>
    <span class="token keyword">gzip_comp_level</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">gzip_types</span>
        application<span class="token operator">/</span>javascript
        application<span class="token operator">/</span>x<span class="token operator">-</span>javascript
        application<span class="token operator">/</span>json
        application<span class="token operator">/</span>xml
        font<span class="token operator">/</span>eot
        font<span class="token operator">/</span>otf
        font<span class="token operator">/</span>ttf
        text<span class="token operator">/</span>css
        text<span class="token operator">/</span>javascript
        text<span class="token operator">/</span>markdown
        text<span class="token operator">/</span>plain<span class="token punctuation">;</span>

    <span class="token keyword">map</span> <span class="token variable">$sent_http_content_type</span> <span class="token variable">$x_frame_options</span> <span class="token punctuation">{</span>
        <span class="token operator">~</span><span class="token operator">*</span>text<span class="token operator">/</span>html <span class="token keyword">DENY</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">map</span> <span class="token variable">$sent_http_content_type</span> <span class="token variable">$content_security_policy</span> <span class="token punctuation">{</span>
        <span class="token operator">~</span><span class="token operator">*</span>text<span class="token operator">/</span>html <span class="token string">"default-src 'self' *.kejiweixun.com; base-uri 'none'; form-action 'self' *.kejiweixun.com; frame-ancestors 'self' *.kejiweixun.com; script-src 'self' 'unsafe-inline' *.kejiweixun.com https://www.google-analytics.com; style-src 'self' *.kejiweixun.com 'unsafe-inline'; img-src 'self' *.kejiweixun.com data: https://www.google-analytics.com; object-src 'self'; connect-src 'self' *.kejiweixun.com https://www.google-analytics.com"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">map</span> <span class="token variable">$sent_http_content_type</span> <span class="token variable">$referrer_policy</span> <span class="token punctuation">{</span>
        <span class="token operator">~</span><span class="token operator">*</span>text<span class="token operator">/</span>html <span class="token string">"same-origin"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">include</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token punctuation">.</span>d<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf<span class="token punctuation">;</span>	
<span class="token punctuation">}</span> </code></pre></div>
<p>nginx 的<strong>主配置</strong>文件叫 <code class="language-text">nginx.conf</code>, 通常位于 <code class="language-text">/usr/local/nginx/conf</code> 或 <code class="language-text">/etc/nginx</code> 或 <code class="language-text">/usr/local/etc/nginx</code>. 主配置文件中的一条条配置信息被称作 <code class="language-text">directive</code>, directive 有两种, 分别是 simple directive 和 block directive. </p>
<p>simple directive 的格式是 <code class="language-text">directive 的名称 + 空格 + 参数 + 分号标点</code>, 例如 <code class="language-text">include /etc/nginx/conf.d/*.conf;</code> 就是一个 simple directive, 意思是把 <code class="language-text">/etc/nginx/conf.d/*.conf</code> 这个配置文件添加到 <code class="language-text">nginx.conf</code> 中.</p>
<p>block directive 的格式也差不多, 区别是分号标点 <code class="language-text">;</code> 换成了 <code class="language-text">{}</code>, {} 里可能有多个 simple directive. 如果一个 block directive 包含有其他 directive, 那这个 block directive 也被称作 context, 例如 <code class="language-text">http {}</code> 就是一个 context.</p>
<p>events 是一个和 http 同级的 directive, 它们两个所在的 context 被称作 main context, http 这个 context 通常包含一个或多个叫 server 的 context, server 可能包含一个或多个叫 location 的 context, 形成如下结构:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main
  events
  http
     server
        location</code></pre></div>
<p>当然除此之外还有其他 context, 例如 upstream 等.</p>
<p>在我的 nginx.conf 配置文件中, 关于 header 的部分就是几个位于 http 里的 map directive, 例如其中一个是:</p>
<div class="gatsby-highlight" data-language="nginx"><pre class="language-nginx"><code class="language-nginx"><span class="token keyword">map</span>  <span class="token variable">$sent_http_content_type</span>  <span class="token variable">$x_frame_options</span> <span class="token punctuation">{</span>
      <span class="token operator">~</span><span class="token operator">*</span>text<span class="token operator">/</span>html             <span class="token keyword">DENY</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>它的意思是, 当 <code class="language-text">sent_http_content_type</code> 这个变量的值是 <code class="language-text">~*text/html</code> 时, 就创建一个叫 <code class="language-text">x_frame_options</code> 的变量, 并给这个变量赋值 <code class="language-text">DENY</code>. <code class="language-text">x_frame_options</code> 这个变量接着将被 server context 引用.</p>
<h3>/conf.d/default.conf</h3>
<p>前面我说过了, nginx.conf 可以通过 include 这个 directive 引入其他配置文件的配置信息, 通常我们把这些配置文件放在与 nginx.conf 位于同一路径下的 conf.d 文件夹中,  在这个例子中, 这个其他配置文件就是 /conf.d/default.conf:</p>
<div class="gatsby-highlight" data-language="nginx"><pre class="language-nginx"><code class="language-nginx"><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span> www<span class="token punctuation">.</span>kejiweixun<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">301</span> <span class="token variable">$scheme</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>kejiweixun<span class="token punctuation">.</span>com<span class="token variable">$request_uri</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">server</span> <span class="token punctuation">{</span>	
    <span class="token keyword">listen</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>	
    <span class="token keyword">server_name</span>  kejiweixun<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
    <span class="token keyword">root</span>         <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token punctuation">;</span>
    
    <span class="token keyword">charset</span> utf<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">;</span>

    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>	
        <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>	
        <span class="token keyword">add_header</span> cache<span class="token operator">-</span>control <span class="token string">"public, max-age=31536000, immutable"</span> always<span class="token punctuation">;</span>	
        <span class="token keyword">add_header</span> X<span class="token operator">-</span>Content<span class="token operator">-</span>Type<span class="token operator">-</span>Options nosniff always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> X<span class="token operator">-</span>Frame<span class="token operator">-</span>Options <span class="token variable">$x_frame_options</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> Content<span class="token operator">-</span>Security<span class="token operator">-</span>Policy <span class="token variable">$content_security_policy</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> Referrer<span class="token operator">-</span>Policy <span class="token variable">$referrer_policy</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Origin <span class="token string">"https://kejiweixun.com"</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> Strict<span class="token operator">-</span>Transport<span class="token operator">-</span>Security <span class="token string">"max-age=31536000"</span> always<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	
    <span class="token keyword">location</span> <span class="token operator">/</span>sw<span class="token punctuation">.</span>js <span class="token punctuation">{</span>	
        <span class="token keyword">add_header</span> cache<span class="token operator">-</span>control <span class="token string">"public, max-age=0, must-revalidate"</span> always<span class="token punctuation">;</span>	
        <span class="token keyword">add_header</span> X<span class="token operator">-</span>Content<span class="token operator">-</span>Type<span class="token operator">-</span>Options nosniff always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Origin <span class="token string">"https://kejiweixun.com"</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> Strict<span class="token operator">-</span>Transport<span class="token operator">-</span>Security <span class="token string">"max-age=31536000"</span> always<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	
    <span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span>html<span class="token operator">|</span>htm<span class="token punctuation">)</span>$  <span class="token punctuation">{</span>	
        <span class="token keyword">add_header</span> cache<span class="token operator">-</span>control <span class="token string">"public, max-age=0, must-revalidate"</span> always<span class="token punctuation">;</span>	
        <span class="token keyword">add_header</span> X<span class="token operator">-</span>Content<span class="token operator">-</span>Type<span class="token operator">-</span>Options nosniff always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> X<span class="token operator">-</span>Frame<span class="token operator">-</span>Options <span class="token variable">$x_frame_options</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> Content<span class="token operator">-</span>Security<span class="token operator">-</span>Policy <span class="token variable">$content_security_policy</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> Referrer<span class="token operator">-</span>Policy <span class="token variable">$referrer_policy</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Origin <span class="token string">"https://kejiweixun.com"</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> Strict<span class="token operator">-</span>Transport<span class="token operator">-</span>Security <span class="token string">"max-age=31536000"</span> always<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	
    <span class="token keyword">location</span> <span class="token operator">/</span>page<span class="token operator">-</span>data<span class="token operator">/</span> <span class="token punctuation">{</span>	
        <span class="token keyword">add_header</span> cache<span class="token operator">-</span>control <span class="token string">"public, max-age=0, must-revalidate"</span> always<span class="token punctuation">;</span>	
        <span class="token keyword">add_header</span> X<span class="token operator">-</span>Content<span class="token operator">-</span>Type<span class="token operator">-</span>Options nosniff always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Origin <span class="token string">"https://kejiweixun.com"</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> Strict<span class="token operator">-</span>Transport<span class="token operator">-</span>Security <span class="token string">"max-age=31536000"</span> always<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	

    <span class="token keyword">error_page</span> <span class="token number">404</span> <span class="token operator">/</span><span class="token number">404.</span>html<span class="token punctuation">;</span>	
<span class="token punctuation">}</span> </code></pre></div>
<p>我没有在 nginx.conf 文件的 http context 中直接定义 server context, 而是把它写在 /conf.d/default.conf 这个文件中, 很多人都喜欢把 server context 从 http context 分离出来.</p>
<p>一个 http context 可以包含多个 server directive, 我这里就包含了两个, 不同 server 之间通过 listen 端口以及 server_name 的不同进行区分. 我这里两个 server 都 listen 80 端口, 但其中一个 server_name 是 www.kejiweixun.com, 另一个是 kejiweixun.com.</p>
<p>第一个 server 的作用是把所有带 www 的链接 301 跳转到没有 www 的链接, 所以第二个 server 才是最终起作用的 server.</p>
<p>第二个 server context 包含了 4 个 location context, 我之所以写了 4 个 location, 是因为我希望给这 4 个 location 分别单独设置 cache-control header. 关于为什么要这样做, 可以参考 gatsby.js 的<a href="https://www.gatsbyjs.org/docs/caching/">官方文档</a>. </p>
<p>cache-control header 不仅影响浏览器的缓存方式, 也影响 CDN 的缓存方式. gatsby.js 部署到 CDN 时, 可以让整个网站的文件都通过 CDN 提供, 但这样做的话, 以后每次对网站进行修改, 例如添加一篇新的文章等等, 都要手动进行缓存刷新, 否则浏览器可能无法马上看到更新后的内容, 因为如果不刷新, CDN 会继续向浏览器提供旧的缓存. 所以 gatsby 建议我们把 html 文件, sw.js, 和所有位于 page-data 文件夹中的 json 文件, 都设置为每次 request 均从源站获取.</p>
<p>当然, 其实我不需要在 nginx 设置这个 cache-control header, 因为也可以在 CDN 设置, 如下图所示:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; color: grey; margin: 0; padding: 0"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 28.500000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAAr0lEQVQY03WQUQoCMQxEe/9LeBTP4o+ICCIr2zZpM2Yq1Sy6gdAkbV7SSffbGUU6VBW1VneBiGDJhlw7AMM0s2+8Z+lwXHC6LKhlRe+G1pqfPqB53G0ACZqwGe95uj7MAW2AaNyOQARIznnUmfOOp4iOngjjXYLpZvIExq0oRWzmsCrmUtkvUFQ3+rA5AunUN+aUoarhWf4Ap2YTwu8Ruv2efN68a9037FiLx6FOfwFPtdoGZ8bQ9gAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/a3033e48e612ecb5bdc7e56b278f4b46/ba381/cdn-cache-control.webp 200w,
/static/a3033e48e612ecb5bdc7e56b278f4b46/7f61c/cdn-cache-control.webp 400w,
/static/a3033e48e612ecb5bdc7e56b278f4b46/d00b9/cdn-cache-control.webp 800w,
/static/a3033e48e612ecb5bdc7e56b278f4b46/92f8c/cdn-cache-control.webp 1200w,
/static/a3033e48e612ecb5bdc7e56b278f4b46/fad48/cdn-cache-control.webp 1600w,
/static/a3033e48e612ecb5bdc7e56b278f4b46/cf4a0/cdn-cache-control.webp 2658w"
          sizes="(max-width: 800px) 100vw, 800px"
          type="image/webp"
        />
        <source
          srcset="/static/a3033e48e612ecb5bdc7e56b278f4b46/772e8/cdn-cache-control.png 200w,
/static/a3033e48e612ecb5bdc7e56b278f4b46/e17e5/cdn-cache-control.png 400w,
/static/a3033e48e612ecb5bdc7e56b278f4b46/5a190/cdn-cache-control.png 800w,
/static/a3033e48e612ecb5bdc7e56b278f4b46/c1b63/cdn-cache-control.png 1200w,
/static/a3033e48e612ecb5bdc7e56b278f4b46/29007/cdn-cache-control.png 1600w,
/static/a3033e48e612ecb5bdc7e56b278f4b46/f6b04/cdn-cache-control.png 2658w"
          sizes="(max-width: 800px) 100vw, 800px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/a3033e48e612ecb5bdc7e56b278f4b46/5a190/cdn-cache-control.png"
          alt="cdn cache control"
          title="cdn cache control"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<p>但我希望对 header 拥有更充分的控制, 而且我觉得源站才是真相的源头, 所以自己设置了 cache-control header, 于是有了四个 location context.</p>
<p>如果所有 add_header 都写在 location 之外且位于 server 之内, 那这些 add_header 会自动应用于所有 location, 但如果 location 内部同时也写了自己的 add_header, 那 location 之外的 add_header 就会被这个 location 忽略, 所以我需要在每个 location 之中分别写 add_header.</p>
<h2>HTTP 安全性 Header</h2>
<p>接下来分别说说以下 5 个安全性 header:</p>
<ul>
<li>X-Content-Type-Options</li>
<li>X-Frame-Options</li>
<li>Referrer-Policy</li>
<li>Strict-Transport-Security</li>
<li>Feature-Policy</li>
<li>Content-Security-Policy</li>
</ul>
<h3>X-Content-Type-Options</h3>
<p>我把 X-Content-Type-Options 的值设置为 <code class="language-text">nosniff</code>, 意思是 no sniff, 作用是告诉浏览器不要进行 MIME sniffing (MIME 嗅探), 即不要自作主张地更改 Content-Type 的值, 而是完全按照开发者设定的 Content-Type 的值处理收到的文件. 关于 MIME 嗅探是什么, 以及它可能造成的安全问题, 可以看看<a href="https://github.com/caistrong/Blog/issues/83">蔡同学的文章</a>.</p>
<h3>X-Frame-Options</h3>
<p>X-Frame-Options 的值可以是 sameorigin 和 DENY. sameorigin 的意思是, 如果我在 kejiweixun.com 中的某个页面中, 通过 <code class="language-text">&lt;frame&gt;</code> 或 <code class="language-text">&lt;iframe&gt;</code> 或 <code class="language-text">&lt;embed&gt;</code> 或 <code class="language-text">&lt;object&gt;</code> 插入 kejiweixun.com 的另一个页面, 这个被插入的页面可以正常显示出来. </p>
<p>当值是 sameorigin 或 DENY 时, 如果其他网站, 比如 baidu.com 想通过 <code class="language-text">&lt;frame&gt;</code> 或 <code class="language-text">&lt;iframe&gt;</code> 或 <code class="language-text">&lt;embed&gt;</code> 或 <code class="language-text">&lt;object&gt;</code> 这些元素在它的页面中嵌入我的页面, 那我的页面将无法正常显示, 如下所示:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; color: grey; margin: 0; padding: 0"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 32.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAAA3ElEQVQY04WPS26EMBBEff87cQF2fAQCjAFP8C/YKAaPhBlMetAoyo6nWtSin0qN0jRNkiTLMoxxURR5njPGjDHaGDqOXCkIU5p+iZGx72lyz+ektWIjdAQa+H3fSyk550IIpZRUygph62pp8Tb07vGQhPCqEnWl6WBIKzCWlCJK6TAM8kJcQAkhvDYfrA2zecfaHTLP3mhvf8Jij3V5bRvCF3Ecl2UJpa7rtm299+d5hvMGBKfgRFEEn3ddB50Qsu/7Ww43+mf5j6ZpQP4s38rrhXNu/cdxHLcm8AsDWoeyV1z0hAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/68735e33b156ef7a012209562063f150/ba381/x-frame-options.webp 200w,
/static/68735e33b156ef7a012209562063f150/7f61c/x-frame-options.webp 400w,
/static/68735e33b156ef7a012209562063f150/d00b9/x-frame-options.webp 800w,
/static/68735e33b156ef7a012209562063f150/92f8c/x-frame-options.webp 1200w,
/static/68735e33b156ef7a012209562063f150/fad48/x-frame-options.webp 1600w,
/static/68735e33b156ef7a012209562063f150/3c09d/x-frame-options.webp 1648w"
          sizes="(max-width: 800px) 100vw, 800px"
          type="image/webp"
        />
        <source
          srcset="/static/68735e33b156ef7a012209562063f150/772e8/x-frame-options.png 200w,
/static/68735e33b156ef7a012209562063f150/e17e5/x-frame-options.png 400w,
/static/68735e33b156ef7a012209562063f150/5a190/x-frame-options.png 800w,
/static/68735e33b156ef7a012209562063f150/c1b63/x-frame-options.png 1200w,
/static/68735e33b156ef7a012209562063f150/29007/x-frame-options.png 1600w,
/static/68735e33b156ef7a012209562063f150/5fc9a/x-frame-options.png 1648w"
          sizes="(max-width: 800px) 100vw, 800px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/68735e33b156ef7a012209562063f150/5a190/x-frame-options.png"
          alt="x frame options"
          title="x frame options"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<p>X-Frame-Options 可以用来防御 clickjacking, 假设 kejiweixun.com 是一个银行网站, 如果我没有设置 X-Frame-Options, 那坏人就可以搭建一个领取免费奖品的网站, 并用 <code class="language-text">&lt;iframe&gt;</code> 等元素把银行网站的付款页面嵌入这个欺诈网站, 但是这个付款页面用户是看不到的, 这个 <code class="language-text">&lt;iframe&gt;</code> 被领取奖品的页面遮挡在下面了, 当用户点击他能看到的领取按钮时, 实际可能是点了隐藏着的银行页面的转账按钮.</p>
<p>clickjacking 另一个用途是骗点赞, 骗关注, 例如把银行付款按钮换成微博点赞按钮等等.</p>
<h3>Referrer-Policy</h3>
<p>在说 Referrer-Policy 这个 header 之前, 需要先知道 Referrer 这个 header, Referrer 是在发生链接跳转时浏览器发送的 request header, 用来告诉服务器我这个 request 来自哪里.</p>
<p>例如从 kejiweixun.com 首页点击链接跳转到 <a href="https://kejiweixun.com/ios-beta-profile/">https://kejiweixun.com/ios-beta-profile/</a>, 那浏览器会发送一个带有 Referrer header 的请求, 这个 Referrer 的值就是 kejiweixun.com, 因为是从科技微讯的首页 kejiweixun.com 跳转过去的.</p>
<p>如果从 kejiweixun.com 跳转到 google.com, 那 google.com 的服务器也可以获得 <code class="language-text">Referrer: kejiweixun.com</code> 这样的 header. </p>
<p>这个功能让 google analytic 能统计 A 网站有多少访客来自 B 网站, 但因为 url 中可能包含一些敏感信息, 不加思索地把 url 传给任何一个其他网站可能会泄漏用户的隐私信息.</p>
<p>Referrer 是浏览器自动添加到 request 中的, 但开发者可以通过 Referrer-Policy 这个 response header 要求浏览器不要乱来. Referrer-Policy 有 8 种值, 具体可以<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy">参考 MDN</a>. </p>
<p>科技微讯的 url 其实没有什么敏感信息, 所以我设置为 <code class="language-text">strict-origin-when-cross-origin</code>, 表示从 kejiweixun.com 这个网站的任何页面跳转到 kejiweixun.com 的任何其他页面时, 浏览器会发送一个带上 Referrer header 的 request, 其值是完整的 url, 而跳转到其他通过 https 访问的域名时, 也会带上 Referrer header, 但其值永远是 <a href="https://kejiweixun.com">https://kejiweixun.com</a>, 不是完整的 url, 另外, 如果跳转的 url 是非 https, 而是 http 域名, 那不带上 Referrer header.</p>
<h3>Strict-Transport-Security</h3>
<p>简称 HSTS, 用来告诉浏览器, 喂, 以后你访问我这个网站, 麻烦你总是通过 https 访问, 不要用 http.</p>
<p>所以如果用户输入的是 kejiweixun.com 或 <a href="http://kejiweixun.com">http://kejiweixun.com</a> 这样的网址, 浏览器会自动转换成 <a href="https://kejiweixun.com">https://kejiweixun.com</a>, 然后再向科技微讯的服务器发起请求. </p>
<p>所以如果你通过 kejiweixun.com 访问科技微讯, 可能会看到 307 内部跳转:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; color: grey; margin: 0; padding: 0"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 30%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAAsUlEQVQY051QSQ6DMBDj/19se0iLClkJWaASixuHHnqFkSzNJs/YjdEaSmlM04x5Jj5Y1xWMfd9xNhrnHB73G2T/xuDHAo+YErZtq4Rn0Rhj0LYthmGAcwdIuCzLNUJ+KJ5PSKWKdIUYE65GJbTW4lU+1MVLkqaci58TciYyMvOClHI9lv/m9J37nDGvhJQqhEDX9eilrJJDjPDjWAnGEODKji199liHcMz9z3OCNQ9/ATkA0rvoZyLyAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/6ef138898d79a17eab479a3bef3bd2e9/ba381/hsts-redirect.webp 200w,
/static/6ef138898d79a17eab479a3bef3bd2e9/7f61c/hsts-redirect.webp 400w,
/static/6ef138898d79a17eab479a3bef3bd2e9/d00b9/hsts-redirect.webp 800w,
/static/6ef138898d79a17eab479a3bef3bd2e9/92f8c/hsts-redirect.webp 1200w,
/static/6ef138898d79a17eab479a3bef3bd2e9/fad48/hsts-redirect.webp 1600w,
/static/6ef138898d79a17eab479a3bef3bd2e9/8488f/hsts-redirect.webp 1956w"
          sizes="(max-width: 800px) 100vw, 800px"
          type="image/webp"
        />
        <source
          srcset="/static/6ef138898d79a17eab479a3bef3bd2e9/772e8/hsts-redirect.png 200w,
/static/6ef138898d79a17eab479a3bef3bd2e9/e17e5/hsts-redirect.png 400w,
/static/6ef138898d79a17eab479a3bef3bd2e9/5a190/hsts-redirect.png 800w,
/static/6ef138898d79a17eab479a3bef3bd2e9/c1b63/hsts-redirect.png 1200w,
/static/6ef138898d79a17eab479a3bef3bd2e9/29007/hsts-redirect.png 1600w,
/static/6ef138898d79a17eab479a3bef3bd2e9/0faf1/hsts-redirect.png 1956w"
          sizes="(max-width: 800px) 100vw, 800px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/6ef138898d79a17eab479a3bef3bd2e9/5a190/hsts-redirect.png"
          alt="hsts redirect"
          title="hsts redirect"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<p>腾讯云 CDN 有一个 "强制跳转 HTTPS" 的开关, 其本质就是在 response header 中添加 Strict-Transport-Security 这个 header, 这意味着在我的 nginx 服务器设置了这个 header, 那腾讯云 CDN 即使没有启用这个功能, 浏览器也会自动跳转 HTTPS.</p>
<p>HSTS 的值可能是:</p>
<div class="gatsby-highlight" data-language="http"><pre class="language-http"><code class="language-http"><span class="token header-name keyword">Strict-Transport-Security:</span> max-age=31536000; includeSubDomains; preload</code></pre></div>
<p>其中 max-age=31536000 告诉浏览器在接下来的 1 年时间内, 都自动使用 https 访问我的网站, 这是必需的值, 当然时间你可以自定义. includeSubDomains 和 preload 是选填值, 前者告诉浏览器 kejiweixun.com 及其所有子域名都启用 HSTS, 后者告诉浏览器把我这个域名<a href="https://hstspreload.org/">登记在一个目录中</a>. 这个目录就是所谓的 preload list, 在这个 list 的域名都只能通过 https 访问. preload 要谨慎使用, 因为上了 preload 名单再移除的话, 可能要等很久.</p>
<h3>Feature-Policy</h3>
<p>这个 header 挺有趣, 假如 kejiweixun.com 添加了 <code class="language-text">Feature-Policy: display-capture &#39;none&#39;</code> 这样的 header, 那用户在手机上访问我这个网站时, 就不能对我的内容截屏了.</p>
<p>Feature-Policy 顾名思义, 就是设置这个网站可以使用浏览器的什么功能, 不可以使用什么功能. 现在浏览器功能非常丰富, 可以调用相机, 麦克风, 支付, 录屏, 定位, 震动等等, 通过 Feature-Policy, 我们可以告诉浏览器在访问我的这个网站时, 禁用某些功能.</p>
<h3>Content-Security-Policy</h3>
<p>在这么多个安全性 header 中, CSP header 是最复杂的 header, 它的值有无数种.</p>
<p>这是科技微讯的 CSP header:</p>
<div class="gatsby-highlight" data-language="http"><pre class="language-http"><code class="language-http"><span class="token header-name keyword">content-security-policy:</span> default-src 'self' https://*.kejiweixun.com; base-uri 'none'; form-action 'self' https://*.kejiweixun.com; frame-ancestors 'none'; script-src 'self' 'unsafe-inline' https://*.kejiweixun.com https://www.google-analytics.com; style-src 'self' https://*.kejiweixun.com 'unsafe-inline'; img-src 'self' https://*.kejiweixun.com data: https://www.google-analytics.com; object-src 'self'; connect-src 'self' https://*.kejiweixun.com https://www.google-analytics.com</code></pre></div>
<p>为方便查看:</p>
<div class="gatsby-highlight" data-language="http"><pre class="language-http"><code class="language-http">default-src 'self' https://*.kejiweixun.com; 

base-uri 'none'; 

form-action 'self' https://*.kejiweixun.com; 

frame-ancestors 'none'; 

style-src 'self' https://*.kejiweixun.com 'unsafe-inline'; 

script-src 'self' https://*.kejiweixun.com 'unsafe-inline' https://www.google-analytics.com; 

img-src 'self' https://*.kejiweixun.com data: https://www.google-analytics.com; 

connect-src 'self' https://*.kejiweixun.com https://www.google-analytics.com;

object-src 'self'; </code></pre></div>
<p>写法上注意以下几个特点:</p>
<ul>
<li>CSP 的值由多个 directive 组成, directive 之间用分号隔开, 每个 directive 可能都有多个值, 这些值用空格分开;</li>
<li>directive 的值如果是 url 的话不用加冒号, 其他, 例如 self, unsafe-inline 等等要加冒号;</li>
<li>directive 的值被称为 source, 定义哪些来源可以被浏览器执行;</li>
<li>大多数 direcitve 的名称都带有 src 后缀, 这些 directive 又叫 fetch directive;</li>
</ul>
<p>directive 有很多个, 其中比较值得关注的有:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">default-src
作为 fetch directive 的 fallback, 
即如果某些 fetch directive 没有声明, 
就把这些 direcitve 的值视为等于 default-src 的值.

script-src
告诉浏览器可以执行来自哪些地方的 script

style-src
告诉浏览器可以处理来自哪些地方的 style

img-src
告诉浏览器可以显示来自哪些地方的图片

object-src
告诉浏览器可以显示来自哪些 url 的 &lt;object&gt; 
或 &lt;embed&gt; 或 &lt;applet&gt; 等元素的内容

connect-src
告诉浏览器可以 fetch 或 XMLHttpRequest 哪些 url, 等;

base-uri
限制 &lt;base&gt; 元素的 href 属性的值;

form-action
限制 &lt;form&gt; 元素的 action 属性的值;

frame-src
告诉浏览器可以显示来自哪些地方的 &lt;frame&gt;, &lt;iframe&gt; 等元素的内容

frame-ancestors
限制 &lt;frame&gt; 或 &lt;iframe&gt; 或 &lt;object&gt; 或 &lt;embed&gt; 或 &lt;applet&gt;
这些元素的父元素可以是什么,
作用涵盖了 x-frame-options,
但旧浏览器可能不支持 CSP, 
所以建议同时设置 x-frame-options.</code></pre></div>
<p>由于 fetch directive 有 default-src 作为 fallback, 所以不需要定义每一个 fetch directive 的值, 但如果某个 fetch directive 的值不能等于 default-src 的值, 那要单独声明, 当某个 fetch directive 单独声明之后, 它会忽略 default-src 的值.</p>
<p>对于其他 directive, 例如 form-action 和 frame-ancestors, 不声明就代表允许所有 url.</p>
<p>需要注意 frame-ancestors 和 x-frame-options 的区别. 科技微讯同时设置了这两个 header, 当某个第三方域名通过 <code class="language-text">&lt;iframe&gt;</code> 等元素嵌套科技微讯的某个网页时, chrome 会显示:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; color: grey; margin: 0; padding: 0"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 34.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABEElEQVQoz42Q3W6CQBBGef93Ml4YL0wTLSIlaBQFkQWL1gryv6fL9sa2MfZLTmZ3szPfzBjb7RbLsnBdF9u2CYIAz/NwHAff93k/ndgfDogkIRQRYZKy8SMOIkbEMafLhVTF9HgkVhimaTIcDplMJozHYwaDAaPRSBsc05RrFCGcN867HUW4J1OGwg/YLVeE6zXhZsNqYeGpBoT6Y2RZRk+e59xuN01ZlvRqpaRWRS+vU8rFnMaeU89nFNMXfS/MGZXrUK+WlMq0UYZGVVU6Warke9q2pe066qKk+zgjr590eabIkWpMjWpE1vU3TaPjj4K/1b91vQH/19OCUnb94c8EjzD6felO1HiPuF/JM30BzWwYIUuGW0AAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/938ac6e33b066f5d1d7539f5eb818995/ba381/frame-ancestor.webp 200w,
/static/938ac6e33b066f5d1d7539f5eb818995/7f61c/frame-ancestor.webp 400w,
/static/938ac6e33b066f5d1d7539f5eb818995/d00b9/frame-ancestor.webp 800w,
/static/938ac6e33b066f5d1d7539f5eb818995/92f8c/frame-ancestor.webp 1200w,
/static/938ac6e33b066f5d1d7539f5eb818995/07a88/frame-ancestor.webp 1446w"
          sizes="(max-width: 800px) 100vw, 800px"
          type="image/webp"
        />
        <source
          srcset="/static/938ac6e33b066f5d1d7539f5eb818995/772e8/frame-ancestor.png 200w,
/static/938ac6e33b066f5d1d7539f5eb818995/e17e5/frame-ancestor.png 400w,
/static/938ac6e33b066f5d1d7539f5eb818995/5a190/frame-ancestor.png 800w,
/static/938ac6e33b066f5d1d7539f5eb818995/c1b63/frame-ancestor.png 1200w,
/static/938ac6e33b066f5d1d7539f5eb818995/d7ceb/frame-ancestor.png 1446w"
          sizes="(max-width: 800px) 100vw, 800px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/938ac6e33b066f5d1d7539f5eb818995/5a190/frame-ancestor.png"
          alt="frame ancestor"
          title="frame ancestor"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<p>而 directive 的值就更多了, 有无数种可能, 主要分为以下几类:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://*.kejiweixun.com
科技微讯的所有子域名, 但不包括 https://kejiweixun.com

https://kejiweixun.com
精确匹配, 只匹配这一个域名的 url

kejiweixun.com:443
可以规定端口

https: 或 http: 或 data: 或 blob: 等等
可以只设定协议, 匹配所有这种协议的 url

*
匹配所有 url

&#39;none&#39;
屏蔽所有 url

&#39;self&#39;
匹配当前页面的域名元素, 会同时检测域名, 端口, 协议是否匹配, 
都匹配才是匹配

&#39;unsafe-inline&#39;
详见下文

&#39;unsafe-eval&#39;
匹配 eval(), 也是不安全

&#39;strict-dynamic&#39;
要撘配 hash 或 nonce 使用, 具体看 mdn.

&#39;&lt;hash-algorithm&gt;-&lt;base64-value&gt;&#39;
详见下文

&#39;nonce-&lt;base64-value&gt;&#39;
详见下文</code></pre></div>
<h4>'unsafe-inline'</h4>
<p>匹配 inline 的 script 或 style, 因为 inline 的 stript 或 stype 不安全, 所以在前面加了 unsafe, 提醒开发者如果你这样设置, 不够安全.</p>
<p>注意这里的 inline style 不仅仅指 html 元素的 style 属性:</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">='</span><span class="token attr-value"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">'</span></span><span class="token punctuation">></span></span>科技微讯<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span></code></pre></div>
<p>还包括 <code class="language-text">&lt;style&gt;</code> 元素等:</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">
    <span class="token punctuation">{</span> <span class="token property">background</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span> <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span></code></pre></div>
<p>这里的 inline script 包括 <code class="language-text">&lt;script&gt;</code> 元素内部的 script:</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"> 
  <span class="token keyword">var</span> inline <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> 
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<p>也包括 inline event handler 等:</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>alert('科技微讯')<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    点我!
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></code></pre></div>
<h4>'&#x3C;hash-algorithm>-&#x3C;base64-value>'</h4>
<p>这是一个 hash source 的例子:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">&#39;sha256-U53QO64URPPK0Fh7tsq0QACAno68LrPc5G6Avyy07xs=&#39;</code></pre></div>
<p>这个 hash source 表示 <code class="language-text">alert(&#39;Hello world!&#39;);</code>. 对于 inline 的 style 或 script, 可以把这些 style 或 script 用 hash 算法加密, 然后添加到 directive 的值中, 一个 hash source 匹配一个 inline script 或 style, 如果你有无数个 inline script 或 style 恐怕不可行.</p>
<p>网上有 CSP hash source 生成器, 把你的 inline style 或 inline script 复制过去, 会自动生成一个 base64-encoded 的 hash 值.</p>
<p>如果你想手动生成, 可以用这个 node 程序:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">"alert('Hello world!');"</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h4>'nonce-&#x3C;base64-value>'</h4>
<p>这是一个 nonce source 的例子:</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>这里替换成一个随机数<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Hi!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<p>nonce 在密码学语境下指的是一个只使用一次的数字. nonce source 类似 hash source, 区别是 nonce source 不是对 inline style 或 script 进行加密, 而是给这些包含 inline style 或 script 的 html 元素添加一个 nonce 属性, 然后把这个属性添加到 directive 的值中. 随机数只能用一次, 响应浏览器的每次请求都要使用一个新的随机数.</p>
<h3>避免使用 <code class="language-text">unsafe-inline</code></h3>
<p>'unsafe-inline' 是一个不安全的 source, 但科技微讯网站使用了很多 inline 的 style 或 script, 所以我还是选择用 unsafe-inline 了.</p>
<p>不过正如前面所说过的, inline 的 style 或 script 可以用 hash source 或 nonce source 代替. 有人给 gatsby 开发了一款名为 gatsby-plugin-csp 的插件, 可以自动为这些 inline style 或 script 生成 hash, 并添加到 <code class="language-text">&lt;meta&gt;</code> 元素中, 例如:</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Content-Security-Policy<span class="token punctuation">"</span></span>
<span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>base-uri <span class="token entity" title="&#x27;">&amp;#x27;</span>self<span class="token entity" title="&#x27;">&amp;#x27;</span>; default-src <span class="token entity" title="&#x27;">&amp;#x27;</span>self<span class="token entity" title="&#x27;">&amp;#x27;</span>; script-src <span class="token entity" title="&#x27;">&amp;#x27;</span>self<span class="token entity" title="&#x27;">&amp;#x27;</span> <span class="token entity" title="&#x27;">&amp;#x27;</span>sha256-ctSi8cL8mD4Z+B6mC6NGy8pBg8EubnSdgcor00NYCtU=<span class="token entity" title="&#x27;">&amp;#x27;</span>;style-src <span class="token entity" title="&#x27;">&amp;#x27;</span>self<span class="token entity" title="&#x27;">&amp;#x27;</span> <span class="token entity" title="&#x27;">&amp;#x27;</span>sha256-MtxTLcyxVEJFNLEIqbVTaqR4WWr0+lYSZ78AzGmNsuA=<span class="token entity" title="&#x27;">&amp;#x27;</span>; object-src <span class="token entity" title="&#x27;">&amp;#x27;</span>none<span class="token entity" title="&#x27;">&amp;#x27;</span>; form-action <span class="token entity" title="&#x27;">&amp;#x27;</span>self<span class="token entity" title="&#x27;">&amp;#x27;</span>; font-src <span class="token entity" title="&#x27;">&amp;#x27;</span>self<span class="token entity" title="&#x27;">&amp;#x27;</span> data:; connect-src <span class="token entity" title="&#x27;">&amp;#x27;</span>self<span class="token entity" title="&#x27;">&amp;#x27;</span>; img-src <span class="token entity" title="&#x27;">&amp;#x27;</span>self<span class="token entity" title="&#x27;">&amp;#x27;</span> data:;<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code></pre></div>
<p>把 CSP 作为属性添加到 <code class="language-text">&lt;meta&gt;</code> 元素是实现 CSP 的另一种方法, 这样就不用在 header 定义了, 但用 header 定义通常是更好的方法. </p>
<p>需要注意的是, hash source 和 nonce source 都只适用于 <code class="language-text">&lt;style&gt;&lt;/style&gt;</code> <code class="language-text">&lt;script&gt;&lt;/script&gt;</code> 这种 inline style 或 script, 不适用于 style 属性和 inline event handler. 而我猜几乎每位 gatsby 用户都会使用的 gatsby-image 恰恰使用了 style 属性处理图片, 所以 gatsby-plugin-csp 这个插件并不能应对所有情况, 还是要用 'unsafe-inline'.</p>
<p>如果你希望严格遵守 CSP, 在写代码的时候就不要用 style 属性, 也不要写 inline event handler. 例如 event handler 本来是这样写的:</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>myFunction()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>点我<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></code></pre></div>
<p>要改成这样:</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token comment">&lt;!--html--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>myButton<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>点我<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<p>和:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">//script.js</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"myButton"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> myFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">myFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'asd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>这款插件并不适合我, 所以我选择使用 <code class="language-text">unsafe-inline</code>. gatsby.js 用户已经在<a href="https://github.com/gatsbyjs/gatsby/issues/10890">讨论怎么让 gatsby 更好地实现 CSP</a>, 但至少到目前为止还没有很好的方法.</p>
<h2>总结</h2>
<p>对于 web 开发而言, HTTP header 是非常重要的知识点, 一个 header 看起来很简单, 却可能对网站产生重要影响. 我很早就开始使用腾讯云 CDN, 但直到现在才大体明白原来 CDN 里的各项设置其实是通过 header 影响网站的行为, 终于明白这些设置选项都是什么意思, 有什么用.</p>
<p>最后关于 HTTP header, 可以再看看 <a href="https://scotthelme.co.uk/">Scott Helme</a> 和 <a href="https://www.fastly.com/blog/andrew-betts">Andrew Betts</a> 写的文章.</p></section></article><section id="isso-thread" data-title="如何通过 nginx 给 gatsby 网站设置 CSP 等安全性 header" data-isso-id="blog/gatsby-content-security-policy/"></section></main></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-60007929-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/gatsby-content-security-policy/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-68528c3be76e45e09e78.js"],"app":["/app-d7aa27b69b62e639b033.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-b81c43cf3b4ef9854106.js"],"component---src-pages-404-js":["/component---src-pages-404-js-530dc74f3729567ff566.js"],"component---src-pages-about-js":["/component---src-pages-about-js-1a3d0ff1c240266832fc.js"],"component---src-pages-add-watermark-js":["/component---src-pages-add-watermark-js-3fd81548efffde6bd677.js"],"component---src-pages-apple-features-availability-js":["/component---src-pages-apple-features-availability-js-2d379a64e73d5fa6eee7.js"],"component---src-pages-index-js":["/component---src-pages-index-js-46ef703221b6beb8a5dd.js"],"component---src-pages-ios-beta-profile-js":["/component---src-pages-ios-beta-profile-js-c4b28110272c21e2e966.js"],"component---src-pages-ios-version-history-js":["/component---src-pages-ios-version-history-js-9917134ee9fea67b67e2.js"],"component---src-pages-merge-images-js":["/component---src-pages-merge-images-js-893696341ffd37ba8c20.js"],"component---src-template-blog-post-template-js":["/component---src-template-blog-post-template-js-c8fda92863f7ed573f2e.js"]};/*]]>*/</script><script src="/polyfill-68528c3be76e45e09e78.js" nomodule=""></script><script src="/component---src-template-blog-post-template-js-c8fda92863f7ed573f2e.js" async=""></script><script src="/9ba78b2a4bb1c73a766a26f9c15557f1bc98f749-4fa9ef365c7ed6c25274.js" async=""></script><script src="/app-d7aa27b69b62e639b033.js" async=""></script><script src="/styles-7573517523cb2796c77b.js" async=""></script><script src="/framework-a38040c4749cf445737f.js" async=""></script><script src="/webpack-runtime-fb3a021dbcd73df034de.js" async=""></script></body></html>