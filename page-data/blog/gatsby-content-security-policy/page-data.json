{"componentChunkName":"component---src-template-blog-post-template-js","path":"/blog/gatsby-content-security-policy/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h2>nginx 配置 header</h2>\n<p>HTTP Header 有一大类叫 security header, 即专门用来提高网站安全性的 header, 都是 response header. 你可以使用 <a href=\"https://observatory.mozilla.org/\">mozilla observatory</a> 或 <a href=\"https://securityheaders.com/\">security headers</a> 检测自己网站的 header 有哪些需要改善的地方.</p>\n<p>安全性 header 主要有以下几个, <a href=\"https://kejiweixun.com\">kejiweixun.com</a> 已经设置了除 feature policy 之外的五个:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; color: grey; font-size: 0.8rem; text-align: center; margin: 2rem auto; padding: 0; border: 1px solid #eee\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.714285714285715%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA6UlEQVQI103LUUvCUBjG8X0+b/ocgvQdgq66C7oICkK66FYsUqS5qSgZqNAUh4aT7Ww6cTtnZ5ue6c7e3u6CH8/V/1FMEg4Xy2/LW3oxcpl0o8Jh0qY5csIzQTQnTP6HDVKaxmvl+eLu4zrJwN4E2yBOTrDncrOXNIajhBQgzSEVkGaAzd8K4KJAysvnU7lauqpdMlE4W+ruokxCdz64fbt51B/q7apWu+98vWtmvz3Te+ZAnenjtcEFRMdCsQNfm6tT14wzID7bscPhDFPnpzFqtgx9MupZaotYK48nJKQeiwilPk/wiX4B7R3RoPRDmukAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/3eabd395b12ed251c7c258cbeb6a93dc/c54d4/security-headers.webp 175w,\n/static/3eabd395b12ed251c7c258cbeb6a93dc/a3432/security-headers.webp 350w,\n/static/3eabd395b12ed251c7c258cbeb6a93dc/426ac/security-headers.webp 700w,\n/static/3eabd395b12ed251c7c258cbeb6a93dc/c139f/security-headers.webp 1050w,\n/static/3eabd395b12ed251c7c258cbeb6a93dc/7f403/security-headers.webp 1400w,\n/static/3eabd395b12ed251c7c258cbeb6a93dc/57b3a/security-headers.webp 2376w\"\n              sizes=\"(max-width: 700px) 100vw, 700px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/3eabd395b12ed251c7c258cbeb6a93dc/4edbd/security-headers.png 175w,\n/static/3eabd395b12ed251c7c258cbeb6a93dc/13ae7/security-headers.png 350w,\n/static/3eabd395b12ed251c7c258cbeb6a93dc/8c557/security-headers.png 700w,\n/static/3eabd395b12ed251c7c258cbeb6a93dc/e996b/security-headers.png 1050w,\n/static/3eabd395b12ed251c7c258cbeb6a93dc/2cefc/security-headers.png 1400w,\n/static/3eabd395b12ed251c7c258cbeb6a93dc/59058/security-headers.png 2376w\"\n            sizes=\"(max-width: 700px) 100vw, 700px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/3eabd395b12ed251c7c258cbeb6a93dc/8c557/security-headers.png\"\n            alt=\"security headers\"\n            title=\"security headers\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n    </span></p>\n<p>kejiweixun.com 是用 gatsby.js 生成的静态网站, 用 nginx 作为 web server, 使用腾讯云 CDN 提高网站访问速度, nginx 和 CDN 都可以对 response header 进行设置.</p>\n<p>这篇文章主要讨论如何在 nginx 设置这些安全性 header, 会顺带分享如何在 CDN 进行相对应的设置.</p>\n<h3>nginx.conf</h3>\n<p>在 nginx 设置, 其实就是修改 nginx 的配置文件, github 的 <a href=\"https://github.com/h5bp/server-configs-nginx\">h5bp/server-configs-nginx</a> 很有参考价值, 根据这个 repo, 我把我的 nginx.conf 配置文件修改为:</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token operator\">/</span><span class=\"token operator\">/</span>nginx<span class=\"token punctuation\">.</span>conf文件\n\n<span class=\"token keyword\">user</span> nginx<span class=\"token punctuation\">;</span>\t\n<span class=\"token keyword\">worker_processes</span>  auto<span class=\"token punctuation\">;</span>\t\n\n<span class=\"token keyword\">error_log</span>  <span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>log<span class=\"token operator\">/</span>nginx<span class=\"token operator\">/</span>error<span class=\"token punctuation\">.</span>log warn<span class=\"token punctuation\">;</span>\t\n<span class=\"token keyword\">pid</span>        <span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>run<span class=\"token operator\">/</span>nginx<span class=\"token punctuation\">.</span><span class=\"token keyword\">pid</span><span class=\"token punctuation\">;</span>\t\n\n<span class=\"token keyword\">events</span> <span class=\"token punctuation\">{</span>\t\n    <span class=\"token keyword\">worker_connections</span>  <span class=\"token number\">1024</span><span class=\"token punctuation\">;</span>\t\n<span class=\"token punctuation\">}</span>\t\n\n<span class=\"token keyword\">http</span> <span class=\"token punctuation\">{</span>\t\n    <span class=\"token keyword\">server_tokens</span> off<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">include</span>       <span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span>nginx<span class=\"token operator\">/</span>mime<span class=\"token punctuation\">.</span><span class=\"token keyword\">types</span><span class=\"token punctuation\">;</span>\t\n    <span class=\"token keyword\">default_type</span>  application<span class=\"token operator\">/</span>octet<span class=\"token operator\">-</span>stream<span class=\"token punctuation\">;</span>\t\n\n    <span class=\"token keyword\">log_format</span>  main  <span class=\"token string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span>\t\n                      <span class=\"token string\">'$status $body_bytes_sent \"$http_referer\" '</span>\t\n                      <span class=\"token string\">'\"$http_user_agent\" \"$http_x_forwarded_for\"'</span><span class=\"token punctuation\">;</span>\t\n\n    <span class=\"token keyword\">access_log</span>  <span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>log<span class=\"token operator\">/</span>nginx<span class=\"token operator\">/</span>access<span class=\"token punctuation\">.</span>log  main<span class=\"token punctuation\">;</span>\t\n\n    <span class=\"token keyword\">sendfile</span>        on<span class=\"token punctuation\">;</span>\t\n    <span class=\"token keyword\">tcp_nopush</span>      on<span class=\"token punctuation\">;</span>\t\n\n    <span class=\"token keyword\">keepalive_timeout</span>  <span class=\"token number\">65</span>s<span class=\"token punctuation\">;</span>\t\n\n    <span class=\"token keyword\">gzip</span>  on<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">gzip_comp_level</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">gzip_types</span>\n        application<span class=\"token operator\">/</span>javascript\n        application<span class=\"token operator\">/</span>x<span class=\"token operator\">-</span>javascript\n        application<span class=\"token operator\">/</span>json\n        application<span class=\"token operator\">/</span>xml\n        font<span class=\"token operator\">/</span>eot\n        font<span class=\"token operator\">/</span>otf\n        font<span class=\"token operator\">/</span>ttf\n        text<span class=\"token operator\">/</span>css\n        text<span class=\"token operator\">/</span>javascript\n        text<span class=\"token operator\">/</span>markdown\n        text<span class=\"token operator\">/</span>plain<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">map</span> <span class=\"token variable\">$sent_http_content_type</span> <span class=\"token variable\">$x_frame_options</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">~</span><span class=\"token operator\">*</span>text<span class=\"token operator\">/</span>html <span class=\"token keyword\">DENY</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">map</span> <span class=\"token variable\">$sent_http_content_type</span> <span class=\"token variable\">$content_security_policy</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">~</span><span class=\"token operator\">*</span>text<span class=\"token operator\">/</span>html <span class=\"token string\">\"default-src 'self' *.kejiweixun.com; base-uri 'none'; form-action 'self' *.kejiweixun.com; frame-ancestors 'self' *.kejiweixun.com; script-src 'self' 'unsafe-inline' *.kejiweixun.com https://www.google-analytics.com; style-src 'self' *.kejiweixun.com 'unsafe-inline'; img-src 'self' *.kejiweixun.com data: https://www.google-analytics.com; object-src 'self'; connect-src 'self' *.kejiweixun.com https://www.google-analytics.com\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">map</span> <span class=\"token variable\">$sent_http_content_type</span> <span class=\"token variable\">$referrer_policy</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">~</span><span class=\"token operator\">*</span>text<span class=\"token operator\">/</span>html <span class=\"token string\">\"same-origin\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">include</span> <span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span>nginx<span class=\"token operator\">/</span>conf<span class=\"token punctuation\">.</span>d<span class=\"token operator\">/</span><span class=\"token operator\">*</span><span class=\"token punctuation\">.</span>conf<span class=\"token punctuation\">;</span>\t\n<span class=\"token punctuation\">}</span> </code></pre></div>\n<p>nginx 的<strong>主配置</strong>文件叫 <code class=\"language-text\">nginx.conf</code>, 通常位于 <code class=\"language-text\">/usr/local/nginx/conf</code> 或 <code class=\"language-text\">/etc/nginx</code> 或 <code class=\"language-text\">/usr/local/etc/nginx</code>. 主配置文件中的一条条配置信息被称作 <code class=\"language-text\">directive</code>, directive 有两种, 分别是 simple directive 和 block directive. </p>\n<p>simple directive 的格式是 <code class=\"language-text\">directive 的名称 + 空格 + 参数 + 分号标点</code>, 例如 <code class=\"language-text\">include /etc/nginx/conf.d/*.conf;</code> 就是一个 simple directive, 意思是把 <code class=\"language-text\">/etc/nginx/conf.d/*.conf</code> 这个配置文件添加到 <code class=\"language-text\">nginx.conf</code> 中.</p>\n<p>block directive 的格式也差不多, 区别是分号标点 <code class=\"language-text\">;</code> 换成了 <code class=\"language-text\">{}</code>, {} 里可能有多个 simple directive. 如果一个 block directive 包含有其他 directive, 那这个 block directive 也被称作 context, 例如 <code class=\"language-text\">http {}</code> 就是一个 context.</p>\n<p>events 是一个和 http 同级的 directive, 它们两个所在的 context 被称作 main context, http 这个 context 通常包含一个或多个叫 server 的 context, server 可能包含一个或多个叫 location 的 context, 形成如下结构:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">main\n  events\n  http\n     server\n        location</code></pre></div>\n<p>当然除此之外还有其他 context, 例如 upstream 等.</p>\n<p>在我的 nginx.conf 配置文件中, 关于 header 的部分就是几个位于 http 里的 map directive, 例如其中一个是:</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token keyword\">map</span>  <span class=\"token variable\">$sent_http_content_type</span>  <span class=\"token variable\">$x_frame_options</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">~</span><span class=\"token operator\">*</span>text<span class=\"token operator\">/</span>html             <span class=\"token keyword\">DENY</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>它的意思是, 当 <code class=\"language-text\">sent_http_content_type</code> 这个变量的值是 <code class=\"language-text\">~*text/html</code> 时, 就创建一个叫 <code class=\"language-text\">x_frame_options</code> 的变量, 并给这个变量赋值 <code class=\"language-text\">DENY</code>. <code class=\"language-text\">x_frame_options</code> 这个变量接着将被 server context 引用.</p>\n<h3>/conf.d/default.conf</h3>\n<p>前面我说过了, nginx.conf 可以通过 include 这个 directive 引入其他配置文件的配置信息, 通常我们把这些配置文件放在与 nginx.conf 位于同一路径下的 conf.d 文件夹中,  在这个例子中, 这个其他配置文件就是 /conf.d/default.conf:</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token keyword\">server</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">listen</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span><span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">listen</span> <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">server_name</span> www<span class=\"token punctuation\">.</span>kejiweixun<span class=\"token punctuation\">.</span>com<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token number\">301</span> <span class=\"token variable\">$scheme</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>kejiweixun<span class=\"token punctuation\">.</span>com<span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">server</span> <span class=\"token punctuation\">{</span>\t\n    <span class=\"token keyword\">listen</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span><span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">listen</span> <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\t\n    <span class=\"token keyword\">server_name</span>  kejiweixun<span class=\"token punctuation\">.</span>com<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">root</span>         <span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span>share<span class=\"token operator\">/</span>nginx<span class=\"token operator\">/</span>html<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">charset</span> utf<span class=\"token operator\">-</span><span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">location</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">{</span>\t\n        <span class=\"token keyword\">index</span>  <span class=\"token keyword\">index</span><span class=\"token punctuation\">.</span>html <span class=\"token keyword\">index</span><span class=\"token punctuation\">.</span>htm<span class=\"token punctuation\">;</span>\t\n        <span class=\"token keyword\">add_header</span> cache<span class=\"token operator\">-</span>control <span class=\"token string\">\"public, max-age=31536000, immutable\"</span> always<span class=\"token punctuation\">;</span>\t\n        <span class=\"token keyword\">add_header</span> X<span class=\"token operator\">-</span>Content<span class=\"token operator\">-</span>Type<span class=\"token operator\">-</span>Options nosniff always<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">add_header</span> X<span class=\"token operator\">-</span>Frame<span class=\"token operator\">-</span>Options <span class=\"token variable\">$x_frame_options</span> always<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">add_header</span> Content<span class=\"token operator\">-</span>Security<span class=\"token operator\">-</span>Policy <span class=\"token variable\">$content_security_policy</span> always<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">add_header</span> Referrer<span class=\"token operator\">-</span>Policy <span class=\"token variable\">$referrer_policy</span> always<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">add_header</span> Access<span class=\"token operator\">-</span>Control<span class=\"token operator\">-</span><span class=\"token keyword\">Allow</span><span class=\"token operator\">-</span>Origin <span class=\"token string\">\"https://kejiweixun.com\"</span> always<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">add_header</span> Strict<span class=\"token operator\">-</span>Transport<span class=\"token operator\">-</span>Security <span class=\"token string\">\"max-age=31536000\"</span> always<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\t\n    <span class=\"token keyword\">location</span> <span class=\"token operator\">/</span>sw<span class=\"token punctuation\">.</span>js <span class=\"token punctuation\">{</span>\t\n        <span class=\"token keyword\">add_header</span> cache<span class=\"token operator\">-</span>control <span class=\"token string\">\"public, max-age=0, must-revalidate\"</span> always<span class=\"token punctuation\">;</span>\t\n        <span class=\"token keyword\">add_header</span> X<span class=\"token operator\">-</span>Content<span class=\"token operator\">-</span>Type<span class=\"token operator\">-</span>Options nosniff always<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">add_header</span> Access<span class=\"token operator\">-</span>Control<span class=\"token operator\">-</span><span class=\"token keyword\">Allow</span><span class=\"token operator\">-</span>Origin <span class=\"token string\">\"https://kejiweixun.com\"</span> always<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">add_header</span> Strict<span class=\"token operator\">-</span>Transport<span class=\"token operator\">-</span>Security <span class=\"token string\">\"max-age=31536000\"</span> always<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\t\n    <span class=\"token keyword\">location</span> <span class=\"token operator\">~</span><span class=\"token operator\">*</span> \\<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>html<span class=\"token operator\">|</span>htm<span class=\"token punctuation\">)</span>$  <span class=\"token punctuation\">{</span>\t\n        <span class=\"token keyword\">add_header</span> cache<span class=\"token operator\">-</span>control <span class=\"token string\">\"public, max-age=0, must-revalidate\"</span> always<span class=\"token punctuation\">;</span>\t\n        <span class=\"token keyword\">add_header</span> X<span class=\"token operator\">-</span>Content<span class=\"token operator\">-</span>Type<span class=\"token operator\">-</span>Options nosniff always<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">add_header</span> X<span class=\"token operator\">-</span>Frame<span class=\"token operator\">-</span>Options <span class=\"token variable\">$x_frame_options</span> always<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">add_header</span> Content<span class=\"token operator\">-</span>Security<span class=\"token operator\">-</span>Policy <span class=\"token variable\">$content_security_policy</span> always<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">add_header</span> Referrer<span class=\"token operator\">-</span>Policy <span class=\"token variable\">$referrer_policy</span> always<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">add_header</span> Access<span class=\"token operator\">-</span>Control<span class=\"token operator\">-</span><span class=\"token keyword\">Allow</span><span class=\"token operator\">-</span>Origin <span class=\"token string\">\"https://kejiweixun.com\"</span> always<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">add_header</span> Strict<span class=\"token operator\">-</span>Transport<span class=\"token operator\">-</span>Security <span class=\"token string\">\"max-age=31536000\"</span> always<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\t\n    <span class=\"token keyword\">location</span> <span class=\"token operator\">/</span>page<span class=\"token operator\">-</span>data<span class=\"token operator\">/</span> <span class=\"token punctuation\">{</span>\t\n        <span class=\"token keyword\">add_header</span> cache<span class=\"token operator\">-</span>control <span class=\"token string\">\"public, max-age=0, must-revalidate\"</span> always<span class=\"token punctuation\">;</span>\t\n        <span class=\"token keyword\">add_header</span> X<span class=\"token operator\">-</span>Content<span class=\"token operator\">-</span>Type<span class=\"token operator\">-</span>Options nosniff always<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">add_header</span> Access<span class=\"token operator\">-</span>Control<span class=\"token operator\">-</span><span class=\"token keyword\">Allow</span><span class=\"token operator\">-</span>Origin <span class=\"token string\">\"https://kejiweixun.com\"</span> always<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">add_header</span> Strict<span class=\"token operator\">-</span>Transport<span class=\"token operator\">-</span>Security <span class=\"token string\">\"max-age=31536000\"</span> always<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\t\n\n    <span class=\"token keyword\">error_page</span> <span class=\"token number\">404</span> <span class=\"token operator\">/</span><span class=\"token number\">404.</span>html<span class=\"token punctuation\">;</span>\t\n<span class=\"token punctuation\">}</span> </code></pre></div>\n<p>我没有在 nginx.conf 文件的 http context 中直接定义 server context, 而是把它写在 /conf.d/default.conf 这个文件中, 很多人都喜欢把 server context 从 http context 分离出来.</p>\n<p>一个 http context 可以包含多个 server directive, 我这里就包含了两个, 不同 server 之间通过 listen 端口以及 server_name 的不同进行区分. 我这里两个 server 都 listen 80 端口, 但其中一个 server_name 是 www.kejiweixun.com, 另一个是 kejiweixun.com.</p>\n<p>第一个 server 的作用是把所有带 www 的链接 301 跳转到没有 www 的链接, 所以第二个 server 才是最终起作用的 server.</p>\n<p>第二个 server context 包含了 4 个 location context, 我之所以写了 4 个 location, 是因为我希望给这 4 个 location 分别单独设置 cache-control header. 关于为什么要这样做, 可以参考 gatsby.js 的<a href=\"https://www.gatsbyjs.org/docs/caching/\">官方文档</a>. </p>\n<p>cache-control header 不仅影响浏览器的缓存方式, 也影响 CDN 的缓存方式. gatsby.js 部署到 CDN 时, 可以让整个网站的文件都通过 CDN 提供, 但这样做的话, 以后每次对网站进行修改, 例如添加一篇新的文章等等, 都要手动进行缓存刷新, 否则浏览器可能无法马上看到更新后的内容, 因为如果不刷新, CDN 会继续向浏览器提供旧的缓存. 所以 gatsby 建议我们把 html 文件, sw.js, 和所有位于 page-data 文件夹中的 json 文件, 都设置为每次 request 均从源站获取.</p>\n<p>当然, 其实我不需要在 nginx 设置这个 cache-control header, 因为也可以在 CDN 设置, 如下图所示:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; color: grey; font-size: 0.8rem; text-align: center; margin: 2rem auto; padding: 0; border: 1px solid #eee\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.57142857142857%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAArUlEQVQY03WQQRLCMAhFc/9LeBNP4rJuXHRTqyEJfPntoDhVZpgAyX9AynybIG2g9w6RtnlrDfdqeIjCzBCW439WTucFl2mB1BWqhjGGn4o+GBspGyhglvJfXq7zDhk+IY2TEujSN6TW6pPLlvOOJ99Rl2G8K7D+1ZnrhiiAhGUxp5ZueDY7AgnI/8Oc4lyLqT9NvLED+c+HlaNzCLgePdeiCfO9pg5UrFXftfAXLJPZ8xD/LbAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/a3033e48e612ecb5bdc7e56b278f4b46/c54d4/cdn-cache-control.webp 175w,\n/static/a3033e48e612ecb5bdc7e56b278f4b46/a3432/cdn-cache-control.webp 350w,\n/static/a3033e48e612ecb5bdc7e56b278f4b46/426ac/cdn-cache-control.webp 700w,\n/static/a3033e48e612ecb5bdc7e56b278f4b46/c139f/cdn-cache-control.webp 1050w,\n/static/a3033e48e612ecb5bdc7e56b278f4b46/7f403/cdn-cache-control.webp 1400w,\n/static/a3033e48e612ecb5bdc7e56b278f4b46/cf4a0/cdn-cache-control.webp 2658w\"\n              sizes=\"(max-width: 700px) 100vw, 700px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/a3033e48e612ecb5bdc7e56b278f4b46/4edbd/cdn-cache-control.png 175w,\n/static/a3033e48e612ecb5bdc7e56b278f4b46/13ae7/cdn-cache-control.png 350w,\n/static/a3033e48e612ecb5bdc7e56b278f4b46/8c557/cdn-cache-control.png 700w,\n/static/a3033e48e612ecb5bdc7e56b278f4b46/e996b/cdn-cache-control.png 1050w,\n/static/a3033e48e612ecb5bdc7e56b278f4b46/2cefc/cdn-cache-control.png 1400w,\n/static/a3033e48e612ecb5bdc7e56b278f4b46/f6b04/cdn-cache-control.png 2658w\"\n            sizes=\"(max-width: 700px) 100vw, 700px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/a3033e48e612ecb5bdc7e56b278f4b46/8c557/cdn-cache-control.png\"\n            alt=\"cdn cache control\"\n            title=\"cdn cache control\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n    </span></p>\n<p>但我希望对 header 拥有更充分的控制, 而且我觉得源站才是真相的源头, 所以自己设置了 cache-control header, 于是有了四个 location context.</p>\n<p>如果所有 add_header 都写在 location 之外且位于 server 之内, 那这些 add_header 会自动应用于所有 location, 但如果 location 内部同时也写了自己的 add_header, 那 location 之外的 add_header 就会被这个 location 忽略, 所以我需要在每个 location 之中分别写 add_header.</p>\n<h2>HTTP 安全性 Header</h2>\n<p>接下来分别说说以下 5 个安全性 header:</p>\n<ul>\n<li>X-Content-Type-Options</li>\n<li>X-Frame-Options</li>\n<li>Referrer-Policy</li>\n<li>Strict-Transport-Security</li>\n<li>Feature-Policy</li>\n<li>Content-Security-Policy</li>\n</ul>\n<h3>X-Content-Type-Options</h3>\n<p>我把 X-Content-Type-Options 的值设置为 <code class=\"language-text\">nosniff</code>, 意思是 no sniff, 作用是告诉浏览器不要进行 MIME sniffing (MIME 嗅探), 即不要自作主张地更改 Content-Type 的值, 而是完全按照开发者设定的 Content-Type 的值处理收到的文件. 关于 MIME 嗅探是什么, 以及它可能造成的安全问题, 可以看看<a href=\"https://github.com/caistrong/Blog/issues/83\">蔡同学的文章</a>.</p>\n<h3>X-Frame-Options</h3>\n<p>X-Frame-Options 的值可以是 sameorigin 和 DENY. sameorigin 的意思是, 如果我在 kejiweixun.com 中的某个页面中, 通过 <code class=\"language-text\">&lt;frame&gt;</code> 或 <code class=\"language-text\">&lt;iframe&gt;</code> 或 <code class=\"language-text\">&lt;embed&gt;</code> 或 <code class=\"language-text\">&lt;object&gt;</code> 插入 kejiweixun.com 的另一个页面, 这个被插入的页面可以正常显示出来. </p>\n<p>当值是 sameorigin 或 DENY 时, 如果其他网站, 比如 baidu.com 想通过 <code class=\"language-text\">&lt;frame&gt;</code> 或 <code class=\"language-text\">&lt;iframe&gt;</code> 或 <code class=\"language-text\">&lt;embed&gt;</code> 或 <code class=\"language-text\">&lt;object&gt;</code> 这些元素在它的页面中嵌入我的页面, 那我的页面将无法正常显示, 如下所示:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; color: grey; font-size: 0.8rem; text-align: center; margin: 2rem auto; padding: 0; border: 1px solid #eee\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.57142857142857%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA3klEQVQY042PwW6EIBBA+f9v8g88mNhEi4pRFlRAVFxIa1ehE9r0at+BvGTyYEB5nmdZVhRFXddFRAixbZvSmvJhEGJSio3qwQXjXK+rdU5JOU+jkBK9RSil0zRxzqEEkUrtnBv8blty0P75YCMhA8aCNJpSTRpOGsUYgqzveymliECp5zmEcH58+m31i/bLcu3mZbbXog89fxkTjDmtPY8DEUKqqkrTFGMMm4N3XXddlw/3oLZty7JMkgROcOhhFx8J/uYG1ESg+RP4xW98+/IzYq39kX3fnXMw+E/8DStkh974S3eBAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/68735e33b156ef7a012209562063f150/c54d4/x-frame-options.webp 175w,\n/static/68735e33b156ef7a012209562063f150/a3432/x-frame-options.webp 350w,\n/static/68735e33b156ef7a012209562063f150/426ac/x-frame-options.webp 700w,\n/static/68735e33b156ef7a012209562063f150/c139f/x-frame-options.webp 1050w,\n/static/68735e33b156ef7a012209562063f150/7f403/x-frame-options.webp 1400w,\n/static/68735e33b156ef7a012209562063f150/3c09d/x-frame-options.webp 1648w\"\n              sizes=\"(max-width: 700px) 100vw, 700px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/68735e33b156ef7a012209562063f150/4edbd/x-frame-options.png 175w,\n/static/68735e33b156ef7a012209562063f150/13ae7/x-frame-options.png 350w,\n/static/68735e33b156ef7a012209562063f150/8c557/x-frame-options.png 700w,\n/static/68735e33b156ef7a012209562063f150/e996b/x-frame-options.png 1050w,\n/static/68735e33b156ef7a012209562063f150/2cefc/x-frame-options.png 1400w,\n/static/68735e33b156ef7a012209562063f150/5fc9a/x-frame-options.png 1648w\"\n            sizes=\"(max-width: 700px) 100vw, 700px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/68735e33b156ef7a012209562063f150/8c557/x-frame-options.png\"\n            alt=\"x frame options\"\n            title=\"x frame options\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n    </span></p>\n<p>X-Frame-Options 可以用来防御 clickjacking, 假设 kejiweixun.com 是一个银行网站, 如果我没有设置 X-Frame-Options, 那坏人就可以搭建一个领取免费奖品的网站, 并用 <code class=\"language-text\">&lt;iframe&gt;</code> 等元素把银行网站的付款页面嵌入这个欺诈网站, 但是这个付款页面用户是看不到的, 这个 <code class=\"language-text\">&lt;iframe&gt;</code> 被领取奖品的页面遮挡在下面了, 当用户点击他能看到的领取按钮时, 实际可能是点了隐藏着的银行页面的转账按钮.</p>\n<p>clickjacking 另一个用途是骗点赞, 骗关注, 例如把银行付款按钮换成微博点赞按钮等等.</p>\n<h3>Referrer-Policy</h3>\n<p>在说 Referrer-Policy 这个 header 之前, 需要先知道 Referrer 这个 header, Referrer 是在发生链接跳转时浏览器发送的 request header, 用来告诉服务器我这个 request 来自哪里.</p>\n<p>例如从 kejiweixun.com 首页点击链接跳转到 <a href=\"https://kejiweixun.com/ios-beta-profile/\">https://kejiweixun.com/ios-beta-profile/</a>, 那浏览器会发送一个带有 Referrer header 的请求, 这个 Referrer 的值就是 kejiweixun.com, 因为是从科技微讯的首页 kejiweixun.com 跳转过去的.</p>\n<p>如果从 kejiweixun.com 跳转到 google.com, 那 google.com 的服务器也可以获得 <code class=\"language-text\">Referrer: kejiweixun.com</code> 这样的 header. </p>\n<p>这个功能让 google analytic 能统计 A 网站有多少访客来自 B 网站, 但因为 url 中可能包含一些敏感信息, 不加思索地把 url 传给任何一个其他网站可能会泄漏用户的隐私信息.</p>\n<p>Referrer 是浏览器自动添加到 request 中的, 但开发者可以通过 Referrer-Policy 这个 response header 要求浏览器不要乱来. Referrer-Policy 有 8 种值, 具体可以<a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy\">参考 MDN</a>. </p>\n<p>科技微讯的 url 其实没有什么敏感信息, 所以我设置为 <code class=\"language-text\">strict-origin-when-cross-origin</code>, 表示从 kejiweixun.com 这个网站的任何页面跳转到 kejiweixun.com 的任何其他页面时, 浏览器会发送一个带上 Referrer header 的 request, 其值是完整的 url, 而跳转到其他通过 https 访问的域名时, 也会带上 Referrer header, 但其值永远是 <a href=\"https://kejiweixun.com\">https://kejiweixun.com</a>, 不是完整的 url, 另外, 如果跳转的 url 是非 https, 而是 http 域名, 那不带上 Referrer header.</p>\n<h3>Strict-Transport-Security</h3>\n<p>简称 HSTS, 用来告诉浏览器, 喂, 以后你访问我这个网站, 麻烦你总是通过 https 访问, 不要用 http.</p>\n<p>所以如果用户输入的是 kejiweixun.com 或 <a href=\"http://kejiweixun.com\">http://kejiweixun.com</a> 这样的网址, 浏览器会自动转换成 <a href=\"https://kejiweixun.com\">https://kejiweixun.com</a>, 然后再向科技微讯的服务器发起请求. </p>\n<p>所以如果你通过 kejiweixun.com 访问科技微讯, 可能会看到 307 内部跳转:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; color: grey; font-size: 0.8rem; text-align: center; margin: 2rem auto; padding: 0; border: 1px solid #eee\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.28571428571429%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAArklEQVQY051Qyw6DMAzj/39x4oJADPp+V4LhJaXafUTywXblJh72fYdSCqXWhko4zw94ruvCvzMIKTGOL2zbCmsdjLVIKbWwJxiEEFiWhcIMlNbQ2iCEiOM4ngVK2nCaJvDpjBgTns5vw3meIYSkQEHnZuRckHJuyB1cQ4ixa7efS2nvI3ml1DtQ9Q3X9U09bjDGwocA51w73XkPTRpXYUlj7j37vnHunLtnzh98AV0V0uqzrGKrAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/6ef138898d79a17eab479a3bef3bd2e9/c54d4/hsts-redirect.webp 175w,\n/static/6ef138898d79a17eab479a3bef3bd2e9/a3432/hsts-redirect.webp 350w,\n/static/6ef138898d79a17eab479a3bef3bd2e9/426ac/hsts-redirect.webp 700w,\n/static/6ef138898d79a17eab479a3bef3bd2e9/c139f/hsts-redirect.webp 1050w,\n/static/6ef138898d79a17eab479a3bef3bd2e9/7f403/hsts-redirect.webp 1400w,\n/static/6ef138898d79a17eab479a3bef3bd2e9/8488f/hsts-redirect.webp 1956w\"\n              sizes=\"(max-width: 700px) 100vw, 700px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/6ef138898d79a17eab479a3bef3bd2e9/4edbd/hsts-redirect.png 175w,\n/static/6ef138898d79a17eab479a3bef3bd2e9/13ae7/hsts-redirect.png 350w,\n/static/6ef138898d79a17eab479a3bef3bd2e9/8c557/hsts-redirect.png 700w,\n/static/6ef138898d79a17eab479a3bef3bd2e9/e996b/hsts-redirect.png 1050w,\n/static/6ef138898d79a17eab479a3bef3bd2e9/2cefc/hsts-redirect.png 1400w,\n/static/6ef138898d79a17eab479a3bef3bd2e9/0faf1/hsts-redirect.png 1956w\"\n            sizes=\"(max-width: 700px) 100vw, 700px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/6ef138898d79a17eab479a3bef3bd2e9/8c557/hsts-redirect.png\"\n            alt=\"hsts redirect\"\n            title=\"hsts redirect\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n    </span></p>\n<p>腾讯云 CDN 有一个 \"强制跳转 HTTPS\" 的开关, 其本质就是在 response header 中添加 Strict-Transport-Security 这个 header, 这意味着在我的 nginx 服务器设置了这个 header, 那腾讯云 CDN 即使没有启用这个功能, 浏览器也会自动跳转 HTTPS.</p>\n<p>HSTS 的值可能是:</p>\n<div class=\"gatsby-highlight\" data-language=\"http\"><pre class=\"language-http\"><code class=\"language-http\"><span class=\"token header-name keyword\">Strict-Transport-Security:</span> max-age=31536000; includeSubDomains; preload</code></pre></div>\n<p>其中 max-age=31536000 告诉浏览器在接下来的 1 年时间内, 都自动使用 https 访问我的网站, 这是必需的值, 当然时间你可以自定义. includeSubDomains 和 preload 是选填值, 前者告诉浏览器 kejiweixun.com 及其所有子域名都启用 HSTS, 后者告诉浏览器把我这个域名<a href=\"https://hstspreload.org/\">登记在一个目录中</a>. 这个目录就是所谓的 preload list, 在这个 list 的域名都只能通过 https 访问. preload 要谨慎使用, 因为上了 preload 名单再移除的话, 可能要等很久.</p>\n<h3>Feature-Policy</h3>\n<p>这个 header 挺有趣, 假如 kejiweixun.com 添加了 <code class=\"language-text\">Feature-Policy: display-capture &#39;none&#39;</code> 这样的 header, 那用户在手机上访问我这个网站时, 就不能对我的内容截屏了.</p>\n<p>Feature-Policy 顾名思义, 就是设置这个网站可以使用浏览器的什么功能, 不可以使用什么功能. 现在浏览器功能非常丰富, 可以调用相机, 麦克风, 支付, 录屏, 定位, 震动等等, 通过 Feature-Policy, 我们可以告诉浏览器在访问我的这个网站时, 禁用某些功能.</p>\n<h3>Content-Security-Policy</h3>\n<p>在这么多个安全性 header 中, CSP header 是最复杂的 header, 它的值有无数种.</p>\n<p>这是科技微讯的 CSP header:</p>\n<div class=\"gatsby-highlight\" data-language=\"http\"><pre class=\"language-http\"><code class=\"language-http\"><span class=\"token header-name keyword\">content-security-policy:</span> default-src 'self' https://*.kejiweixun.com; base-uri 'none'; form-action 'self' https://*.kejiweixun.com; frame-ancestors 'none'; script-src 'self' 'unsafe-inline' https://*.kejiweixun.com https://www.google-analytics.com; style-src 'self' https://*.kejiweixun.com 'unsafe-inline'; img-src 'self' https://*.kejiweixun.com data: https://www.google-analytics.com; object-src 'self'; connect-src 'self' https://*.kejiweixun.com https://www.google-analytics.com</code></pre></div>\n<p>为方便查看:</p>\n<div class=\"gatsby-highlight\" data-language=\"http\"><pre class=\"language-http\"><code class=\"language-http\">default-src 'self' https://*.kejiweixun.com; \n\nbase-uri 'none'; \n\nform-action 'self' https://*.kejiweixun.com; \n\nframe-ancestors 'none'; \n\nstyle-src 'self' https://*.kejiweixun.com 'unsafe-inline'; \n\nscript-src 'self' https://*.kejiweixun.com 'unsafe-inline' https://www.google-analytics.com; \n\nimg-src 'self' https://*.kejiweixun.com data: https://www.google-analytics.com; \n\nconnect-src 'self' https://*.kejiweixun.com https://www.google-analytics.com;\n\nobject-src 'self'; </code></pre></div>\n<p>写法上注意以下几个特点:</p>\n<ul>\n<li>CSP 的值由多个 directive 组成, directive 之间用分号隔开, 每个 directive 可能都有多个值, 这些值用空格分开;</li>\n<li>directive 的值如果是 url 的话不用加冒号, 其他, 例如 self, unsafe-inline 等等要加冒号;</li>\n<li>directive 的值被称为 source, 定义哪些来源可以被浏览器执行;</li>\n<li>大多数 direcitve 的名称都带有 src 后缀, 这些 directive 又叫 fetch directive;</li>\n</ul>\n<p>directive 有很多个, 其中比较值得关注的有:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">default-src\n作为 fetch directive 的 fallback, \n即如果某些 fetch directive 没有声明, \n就把这些 direcitve 的值视为等于 default-src 的值.\n\nscript-src\n告诉浏览器可以执行来自哪些地方的 script\n\nstyle-src\n告诉浏览器可以处理来自哪些地方的 style\n\nimg-src\n告诉浏览器可以显示来自哪些地方的图片\n\nobject-src\n告诉浏览器可以显示来自哪些 url 的 &lt;object&gt; \n或 &lt;embed&gt; 或 &lt;applet&gt; 等元素的内容\n\nconnect-src\n告诉浏览器可以 fetch 或 XMLHttpRequest 哪些 url, 等;\n\nbase-uri\n限制 &lt;base&gt; 元素的 href 属性的值;\n\nform-action\n限制 &lt;form&gt; 元素的 action 属性的值;\n\nframe-src\n告诉浏览器可以显示来自哪些地方的 &lt;frame&gt;, &lt;iframe&gt; 等元素的内容\n\nframe-ancestors\n限制 &lt;frame&gt; 或 &lt;iframe&gt; 或 &lt;object&gt; 或 &lt;embed&gt; 或 &lt;applet&gt;\n这些元素的父元素可以是什么,\n作用涵盖了 x-frame-options,\n但旧浏览器可能不支持 CSP, \n所以建议同时设置 x-frame-options.</code></pre></div>\n<p>由于 fetch directive 有 default-src 作为 fallback, 所以不需要定义每一个 fetch directive 的值, 但如果某个 fetch directive 的值不能等于 default-src 的值, 那要单独声明, 当某个 fetch directive 单独声明之后, 它会忽略 default-src 的值.</p>\n<p>对于其他 directive, 例如 form-action 和 frame-ancestors, 不声明就代表允许所有 url.</p>\n<p>需要注意 frame-ancestors 和 x-frame-options 的区别. 科技微讯同时设置了这两个 header, 当某个第三方域名通过 <code class=\"language-text\">&lt;iframe&gt;</code> 等元素嵌套科技微讯的某个网页时, chrome 会显示:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; color: grey; font-size: 0.8rem; text-align: center; margin: 2rem auto; padding: 0; border: 1px solid #eee\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.85714285714286%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABEklEQVQoz42OXW+CQBBF+f9/ycQXfTBppLUBUWIKQViwKBSwCOXjdJdqqvbB3uRmdu5Ozozmui6maWLbNpZlIYTA87yhD3yf+HDAl1m42+GHIX4U8+YJRBQRSadZRiJrst+zi2M0XdcZj8fMZjOm0ymj0YjJZMJyuSSWQ5mCrVekW49TKCgC2W993M2GwHUIHAfbMHDsNaE8RMvznExuUfV4PFIUBWVZotT2PXX8Tvo8pzJeaYwFXwudcv7ESfafLzrVyqKSC0vToBEBWl3XXNRLwKW2TUPbttTliS450GUfdEU+uE+TH6t3VdErhnRfV7/AC+xaKuuk//7czZ2t9BA45Of6Hw/A4ZKuu/F1dgN/oG9lDhfGB59jMgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/938ac6e33b066f5d1d7539f5eb818995/c54d4/frame-ancestor.webp 175w,\n/static/938ac6e33b066f5d1d7539f5eb818995/a3432/frame-ancestor.webp 350w,\n/static/938ac6e33b066f5d1d7539f5eb818995/426ac/frame-ancestor.webp 700w,\n/static/938ac6e33b066f5d1d7539f5eb818995/c139f/frame-ancestor.webp 1050w,\n/static/938ac6e33b066f5d1d7539f5eb818995/7f403/frame-ancestor.webp 1400w,\n/static/938ac6e33b066f5d1d7539f5eb818995/07a88/frame-ancestor.webp 1446w\"\n              sizes=\"(max-width: 700px) 100vw, 700px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/938ac6e33b066f5d1d7539f5eb818995/4edbd/frame-ancestor.png 175w,\n/static/938ac6e33b066f5d1d7539f5eb818995/13ae7/frame-ancestor.png 350w,\n/static/938ac6e33b066f5d1d7539f5eb818995/8c557/frame-ancestor.png 700w,\n/static/938ac6e33b066f5d1d7539f5eb818995/e996b/frame-ancestor.png 1050w,\n/static/938ac6e33b066f5d1d7539f5eb818995/2cefc/frame-ancestor.png 1400w,\n/static/938ac6e33b066f5d1d7539f5eb818995/d7ceb/frame-ancestor.png 1446w\"\n            sizes=\"(max-width: 700px) 100vw, 700px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/938ac6e33b066f5d1d7539f5eb818995/8c557/frame-ancestor.png\"\n            alt=\"frame ancestor\"\n            title=\"frame ancestor\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n    </span></p>\n<p>而 directive 的值就更多了, 有无数种可能, 主要分为以下几类:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">https://*.kejiweixun.com\n科技微讯的所有子域名, 但不包括 https://kejiweixun.com\n\nhttps://kejiweixun.com\n精确匹配, 只匹配这一个域名的 url\n\nkejiweixun.com:443\n可以规定端口\n\nhttps: 或 http: 或 data: 或 blob: 等等\n可以只设定协议, 匹配所有这种协议的 url\n\n*\n匹配所有 url\n\n&#39;none&#39;\n屏蔽所有 url\n\n&#39;self&#39;\n匹配当前页面的域名元素, 会同时检测域名, 端口, 协议是否匹配, \n都匹配才是匹配\n\n&#39;unsafe-inline&#39;\n详见下文\n\n&#39;unsafe-eval&#39;\n匹配 eval(), 也是不安全\n\n&#39;strict-dynamic&#39;\n要撘配 hash 或 nonce 使用, 具体看 mdn.\n\n&#39;&lt;hash-algorithm&gt;-&lt;base64-value&gt;&#39;\n详见下文\n\n&#39;nonce-&lt;base64-value&gt;&#39;\n详见下文</code></pre></div>\n<h4>'unsafe-inline'</h4>\n<p>匹配 inline 的 script 或 style, 因为 inline 的 stript 或 stype 不安全, 所以在前面加了 unsafe, 提醒开发者如果你这样设置, 不够安全.</p>\n<p>注意这里的 inline style 不仅仅指 html 元素的 style 属性:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span> <span class=\"token style-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span><span class=\"token style language-css\"><span class=\"token property\">color</span><span class=\"token punctuation\">:</span> red</span><span class=\"token punctuation\">'</span></span></span><span class=\"token punctuation\">></span></span>科技微讯<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>还包括 <code class=\"language-text\">&lt;style&gt;</code> 元素等:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\">\n    <span class=\"token punctuation\">{</span> <span class=\"token property\">background</span><span class=\"token punctuation\">:</span> red<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>这里的 inline script 包括 <code class=\"language-text\">&lt;script&gt;</code> 元素内部的 script:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"> \n  <span class=\"token keyword\">var</span> inline <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> \n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>也包括 inline event handler 等:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onclick</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>alert(<span class=\"token punctuation\">'</span>科技微讯<span class=\"token punctuation\">'</span>)<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    点我!\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h4>'&#x3C;hash-algorithm>-&#x3C;base64-value>'</h4>\n<p>这是一个 hash source 的例子:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&#39;sha256-U53QO64URPPK0Fh7tsq0QACAno68LrPc5G6Avyy07xs=&#39;</code></pre></div>\n<p>这个 hash source 表示 <code class=\"language-text\">alert(&#39;Hello world!&#39;);</code>. 对于 inline 的 style 或 script, 可以把这些 style 或 script 用 hash 算法加密, 然后添加到 directive 的值中, 一个 hash source 匹配一个 inline script 或 style, 如果你有无数个 inline script 或 style 恐怕不可行.</p>\n<p>网上有 CSP hash source 生成器, 把你的 inline style 或 inline script 复制过去, 会自动生成一个 base64-encoded 的 hash 值.</p>\n<p>如果你想手动生成, 可以用这个 node 程序:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> crypto <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crypto'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">createHash</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sha256'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"alert('Hello world!');\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4>'nonce-&#x3C;base64-value>'</h4>\n<p>这是一个 nonce source 的例子:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">nonce</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>这里替换成一个随机数<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Hi!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>nonce 在密码学语境下指的是一个只使用一次的数字. nonce source 类似 hash source, 区别是 nonce source 不是对 inline style 或 script 进行加密, 而是给这些包含 inline style 或 script 的 html 元素添加一个 nonce 属性, 然后把这个属性添加到 directive 的值中. 随机数只能用一次, 响应浏览器的每次请求都要使用一个新的随机数.</p>\n<h3>避免使用 <code class=\"language-text\">unsafe-inline</code></h3>\n<p>'unsafe-inline' 是一个不安全的 source, 但科技微讯网站使用了很多 inline 的 style 或 script, 所以我还是选择用 unsafe-inline 了.</p>\n<p>不过正如前面所说过的, inline 的 style 或 script 可以用 hash source 或 nonce source 代替. 有人给 gatsby 开发了一款名为 gatsby-plugin-csp 的插件, 可以自动为这些 inline style 或 script 生成 hash, 并添加到 <code class=\"language-text\">&lt;meta&gt;</code> 元素中, 例如:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">http-equiv</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Content-Security-Policy<span class=\"token punctuation\">\"</span></span>\n<span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>base-uri <span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>self<span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>; default-src <span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>self<span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>; script-src <span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>self<span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span> <span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>sha256-ctSi8cL8mD4Z+B6mC6NGy8pBg8EubnSdgcor00NYCtU=<span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>;style-src <span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>self<span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span> <span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>sha256-MtxTLcyxVEJFNLEIqbVTaqR4WWr0+lYSZ78AzGmNsuA=<span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>; object-src <span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>none<span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>; form-action <span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>self<span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>; font-src <span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>self<span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span> data:; connect-src <span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>self<span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>; img-src <span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span>self<span class=\"token entity\" title=\"&#x27;\">&amp;#x27;</span> data:;<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>把 CSP 作为属性添加到 <code class=\"language-text\">&lt;meta&gt;</code> 元素是实现 CSP 的另一种方法, 这样就不用在 header 定义了, 但用 header 定义通常是更好的方法. </p>\n<p>需要注意的是, hash source 和 nonce source 都只适用于 <code class=\"language-text\">&lt;style&gt;&lt;/style&gt;</code> <code class=\"language-text\">&lt;script&gt;&lt;/script&gt;</code> 这种 inline style 或 script, 不适用于 style 属性和 inline event handler. 而我猜几乎每位 gatsby 用户都会使用的 gatsby-image 恰恰使用了 style 属性处理图片, 所以 gatsby-plugin-csp 这个插件并不能应对所有情况, 还是要用 'unsafe-inline'.</p>\n<p>如果你希望严格遵守 CSP, 在写代码的时候就不要用 style 属性, 也不要写 inline event handler. 例如 event handler 本来是这样写的:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onclick</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>myFunction()<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>点我<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>要改成这样:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token comment\">&lt;!--html--></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>myButton<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>点我<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>script.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>和:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">//script.js</span>\ndocument<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"myButton\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"click\"</span><span class=\"token punctuation\">,</span> myFunction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">myFunction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'asd'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这款插件并不适合我, 所以我选择使用 <code class=\"language-text\">unsafe-inline</code>. gatsby.js 用户已经在<a href=\"https://github.com/gatsbyjs/gatsby/issues/10890\">讨论怎么让 gatsby 更好地实现 CSP</a>, 但至少到目前为止还没有很好的方法.</p>\n<h2>总结</h2>\n<p>对于 web 开发而言, HTTP header 是非常重要的知识点, 一个 header 看起来很简单, 却可能对网站产生重要影响. 我很早就开始使用腾讯云 CDN, 但直到现在才大体明白原来 CDN 里的各项设置其实是通过 header 影响网站的行为, 终于明白这些设置选项都是什么意思, 有什么用.</p>\n<p>最后关于 HTTP header, 可以再看看 <a href=\"https://scotthelme.co.uk/\">Scott Helme</a> 和 <a href=\"https://www.fastly.com/blog/andrew-betts\">Andrew Betts</a> 写的文章.</p>","frontmatter":{"title":"如何通过 nginx 给 gatsby 网站设置 CSP 等安全性 header","date":"2019/11/12","slug":"gatsby-content-security-policy","description":"科技微讯的博客是用 gatsby.js 生成的静态网站, 部署在 nginx 服务器, 这篇文章分享如何通过修改 nginx 的配置文件, 给 gatsby 网站设置 content security policy 等安全性 HTTP header."}}}]}},"pageContext":{"slug":"gatsby-content-security-policy"}},"staticQueryHashes":["1518281631"]}