{"componentChunkName":"component---src-template-blog-post-template-js","path":"/blog/wechat-miniprogram-canvas-draw-and-export-multiple-images/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<p>现在只有一个 canvas 组件:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>canvas</span> <span class=\"token attr-name\">canvas-id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>canvas<span class=\"token punctuation\">\"</span></span><span class=\"token style-attr language-css\"><span class=\"token attr-name\"> <span class=\"token attr-name\">style</span></span><span class=\"token punctuation\">=\"</span><span class=\"token attr-value\"><span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 50px<span class=\"token punctuation\">;</span> <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 50px</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>canvas</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>需求是: 获取多张高分辨率图片的缩略图, 比如收到一张 1000 x 2000 的图片, 获取其 50 x 50 分辨率的缩略图.</p>\n<p>这个需求可以用 canvas 处理, 如果用小程序旧版的 canvas api, 则是:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getThumbnail</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">image</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> wx<span class=\"token punctuation\">.</span><span class=\"token function\">createCanvasContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"canvas\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">let</span> sWidth<span class=\"token punctuation\">,</span> sHeight\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">.</span>width <span class=\"token operator\">></span> image<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        sWidth <span class=\"token operator\">=</span> sHeight <span class=\"token operator\">=</span> image<span class=\"token punctuation\">.</span>height\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        sWidth <span class=\"token operator\">=</span> sHeight <span class=\"token operator\">=</span> image<span class=\"token punctuation\">.</span>width\n      <span class=\"token punctuation\">}</span>\n      ctx<span class=\"token punctuation\">.</span><span class=\"token function\">drawImage</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> sWidth<span class=\"token punctuation\">,</span> sHeight<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span> <span class=\"token number\">50</span><span class=\"token punctuation\">)</span>\n      ctx<span class=\"token punctuation\">.</span><span class=\"token function\">draw</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        wx<span class=\"token punctuation\">.</span><span class=\"token function\">canvasToTempFilePath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          canvasId<span class=\"token operator\">:</span> <span class=\"token string\">\"canvas\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token function-variable function\">success</span><span class=\"token operator\">:</span> <span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> res<span class=\"token punctuation\">.</span>tempFilePath <span class=\"token comment\">// 这个就是缩略图的本地地址,</span>\n          fail<span class=\"token operator\">:</span> reject<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> allThumbnails <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>images<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">image</span> <span class=\"token operator\">=></span> <span class=\"token function\">getThumbnail</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>上面这样的代码可能出错, 因为用了 <code class=\"language-text\">Promise.all</code>, 最后得到的每张缩略图可能都是相同的. 正确的做法是:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getThumbnail</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">image</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> wx<span class=\"token punctuation\">.</span><span class=\"token function\">createCanvasContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"canvas\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">let</span> sWidth<span class=\"token punctuation\">,</span> sHeight\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">.</span>width <span class=\"token operator\">></span> image<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        sWidth <span class=\"token operator\">=</span> sHeight <span class=\"token operator\">=</span> image<span class=\"token punctuation\">.</span>height\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        sWidth <span class=\"token operator\">=</span> sHeight <span class=\"token operator\">=</span> image<span class=\"token punctuation\">.</span>width\n      <span class=\"token punctuation\">}</span>\n      ctx<span class=\"token punctuation\">.</span><span class=\"token function\">drawImage</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> sWidth<span class=\"token punctuation\">,</span> sHeight<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span> <span class=\"token number\">50</span><span class=\"token punctuation\">)</span>\n      ctx<span class=\"token punctuation\">.</span><span class=\"token function\">draw</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        wx<span class=\"token punctuation\">.</span><span class=\"token function\">canvasToTempFilePath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          canvasId<span class=\"token operator\">:</span> <span class=\"token string\">\"canvas\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token function-variable function\">success</span><span class=\"token operator\">:</span> <span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>tempFilePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 这个就是缩略图的本地地址</span>\n          fail<span class=\"token operator\">:</span> reject<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> allThumbnails <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> <span class=\"token punctuation\">(</span>image <span class=\"token keyword\">of</span> images<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    allThumbnails<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> <span class=\"token function\">getThumbnail</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>这里没有再使用 <code class=\"language-text\">Promise.all</code>, 而是按顺序, 先获取一个缩略图, 再获取下一个缩略图. 更详细地说, 就是在一个固定大小的 canvas 组件的相同位置中 draw 图片, 然后导出图片, 接着在相同的位置 draw 下一张图片, 覆盖原来的图片, 然后再导出新图片, 直到获得所有缩略图.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 499px; color: grey; margin: 0; padding: 0\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAAB2klEQVQ4y41Ty07CQBRtQUQKyKt0piBE0bDBoAv+w7g3EvsYWPgvfoIbMXSmBXRh/Ad/yjMthSIoTnJy7tzMvXOfivLXGT0r1BGhSB2ukKVMbJ6HXAZqxOEVsE4cvwp9WfnPiZ3GBw4K5uOnao7fW3S0uKJsdgouQJ/dMibJSCCvIxRZ3IuG9XogIwEI3pnQN8EascUxdKU4hRWHDm0RYuMjm+eoO9MRzTX4krpBm7hBithePvpAlAA1mcauaDXo8dDLEWsqaySj6VLHvwAbcNAASxxupbnkNIwzxnCSMu4nkGXBeZayuQF0gSYiJNA3gLpMEfdVQGFQ/duPVXph91y/gnRMGFNE0oGuhnsXaQ7APer6fRi28JGaKMc6y6heqxpqMCIwRufmMA6QDq9B3yGWV0HaBSCbdLR2xhNjwUQ8Zxk8oGGRLa8ANknURcyZwOz56fC9629EFcvLX4QqOwSHORoNaR/3HlCV8waWjckkm0cevI1Uf46DLH5eyjqbxroTAF3kR7JRkSNvXWs4rd+JX7aAzdvo1AB8DmhLg1ZyjaQDavtxRnvWyg00dLZmskWmfvMUO8jvGClFYV/799QYvqiIsEzYrEjHbyW5XsDxGeOKbontDu45322zz7DaUSO2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/6923eeef03aaaa4f01bb9c4a3de980d6/ba381/canvas-1.webp 200w,\n/static/6923eeef03aaaa4f01bb9c4a3de980d6/7f61c/canvas-1.webp 400w,\n/static/6923eeef03aaaa4f01bb9c4a3de980d6/f002d/canvas-1.webp 499w\"\n          sizes=\"(max-width: 499px) 100vw, 499px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/6923eeef03aaaa4f01bb9c4a3de980d6/772e8/canvas-1.png 200w,\n/static/6923eeef03aaaa4f01bb9c4a3de980d6/e17e5/canvas-1.png 400w,\n/static/6923eeef03aaaa4f01bb9c4a3de980d6/119c7/canvas-1.png 499w\"\n          sizes=\"(max-width: 499px) 100vw, 499px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/6923eeef03aaaa4f01bb9c4a3de980d6/119c7/canvas-1.png\"\n          alt=\"canvas 1\"\n          title=\"canvas 1\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n    </span></p>\n<p>另一种方法是: 根据收到的原始图片的尺寸动态设置地 canvas 的尺寸, 然后首先把收到的图片全部 draw 进这个 canvas 的不同区域, 最后把这个 canvas 的不同区域分别导出成不同的图片.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; color: grey; margin: 0; padding: 0\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABKklEQVQoz01R7W7DIAxkbQMhNOvHNKD7s1fbEtI8WaUQp+32hjsD0oLk+Djg7HOE62mLMPbrtnNdlC7MDeLoeuR+qoBr4D3C2C6q9+/bBhgcMa9wblwfK2Dcpb2AyMaFRfnx58MPDwsMoVj78dn46+Pir0+Di8p1k/Tjbwvu0w/3Y+L6eesD1dgz94a9FvhAkPAYAsOdHzfcATALnpF14TQKKoRxw6KLoMxdLsajKXTdCGxYUOOAbbbAbEWXOCXu3yJzZ9gERzwOmTHfo1QEHU4Ss9mlWSThJH7Il+nV5z3zB586IsyTcg5kEuYceIZzI2DhAltWlAUSRVBptWzH3CzXnGeBPr6sOf4xgocJ/y5bilXqEp3ZwJZS9SqNIVBbsCo5j6JjYeayoz/8qpjzhYcmTwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/4d3e2aea3f354bad729287eea07b923b/ba381/canvas-2.webp 200w,\n/static/4d3e2aea3f354bad729287eea07b923b/7f61c/canvas-2.webp 400w,\n/static/4d3e2aea3f354bad729287eea07b923b/e88ff/canvas-2.webp 600w\"\n          sizes=\"(max-width: 600px) 100vw, 600px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/4d3e2aea3f354bad729287eea07b923b/772e8/canvas-2.png 200w,\n/static/4d3e2aea3f354bad729287eea07b923b/e17e5/canvas-2.png 400w,\n/static/4d3e2aea3f354bad729287eea07b923b/0a47e/canvas-2.png 600w\"\n          sizes=\"(max-width: 600px) 100vw, 600px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/4d3e2aea3f354bad729287eea07b923b/0a47e/canvas-2.png\"\n          alt=\"canvas 2\"\n          title=\"canvas 2\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n    </span></p>\n<p>这种方法需要注意的问题是, 动态设置 canvas 的尺寸, 最后通过 canvasToTempFilePath 导出图片时, 可能会出现 <code class=\"language-text\">canvasToTempFilePath：fail:cearte bitmap failed</code> 错误.</p>\n<p>我试验得到的结论是, 用 setData 动态设置 canvas 尺寸, 在 setData 的回调函数中获取 ctx 并 draw, 手机上删除小程序的开发版, 重新扫描二维码预览, 第一次打开小程序并选择图片, 会出现上述错误, 接着退出小程序再打开就好了. 如果没有在 setData 的回调函数中获取 ctx 并 draw, 那会一直出错.</p>\n<p>一种不怎么完美的解决方法是, 除了把 ctx 和 draw 放在 setData 的回调函数之外, 还需要让 <code class=\"language-text\">ctx.draw()</code> 中的回调函数整个地放在 setTime 中延迟执行.</p>\n<p>比如 canvas 组件是这样的:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>canvas</span>\n  <span class=\"token attr-name\">canvas-id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>canvas<span class=\"token punctuation\">\"</span></span><span class=\"token style-attr language-css\"><span class=\"token attr-name\">\n  <span class=\"token attr-name\">style</span></span><span class=\"token punctuation\">=\"</span><span class=\"token attr-value\"><span class=\"token selector\">width:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>canvasWidth<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>px<span class=\"token selector\">; height:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>canvasHeight<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>px</span><span class=\"token punctuation\">\"</span></span>\n<span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>canvas</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>然后</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 通过 setData 设置 canvas 的尺寸</span>\nthi<span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">{</span>\n    canvasWidth<span class=\"token operator\">:</span> <span class=\"token number\">50</span> <span class=\"token operator\">*</span> images<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span>\n    canvasHeight<span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 把代码放在 setData 的回调函数中</span>\n  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> wx<span class=\"token punctuation\">.</span><span class=\"token function\">createCanvasContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"canvas\"</span><span class=\"token punctuation\">)</span>\n    images<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">image<span class=\"token punctuation\">,</span> index</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">let</span> sWidth<span class=\"token punctuation\">,</span> sHeight\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">.</span>width <span class=\"token operator\">></span> image<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        sWidth <span class=\"token operator\">=</span> sHeight <span class=\"token operator\">=</span> image<span class=\"token punctuation\">.</span>height\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        sWidth <span class=\"token operator\">=</span> sHeight <span class=\"token operator\">=</span> image<span class=\"token punctuation\">.</span>width\n      <span class=\"token punctuation\">}</span>\n      ctx<span class=\"token punctuation\">.</span><span class=\"token function\">drawImage</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> sWidth<span class=\"token punctuation\">,</span> sHeight<span class=\"token punctuation\">,</span> <span class=\"token number\">50</span> <span class=\"token operator\">*</span> index<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span> <span class=\"token number\">50</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    ctx<span class=\"token punctuation\">.</span><span class=\"token function\">draw</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 把 ctx.draw 的整个回调函数包裹在 setTime 中</span>\n      <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getThumbnail</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">index</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            wx<span class=\"token punctuation\">.</span><span class=\"token function\">canvasToTempFilePath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              canvasId<span class=\"token operator\">:</span> <span class=\"token string\">\"canvas\"</span><span class=\"token punctuation\">,</span>\n              <span class=\"token function-variable function\">success</span><span class=\"token operator\">:</span> <span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>tempFilePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 这个就是缩略图的本地地址</span>\n              fail<span class=\"token operator\">:</span> reject<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">const</span> thumbnail <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>\n          images<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">image<span class=\"token punctuation\">,</span> index</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">getThumbnail</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>另一种解决方法是, 可以像第一种写法那样, 给 canvas 设定一个固定的尺寸. 既然缩略图是 50 x 50, 如果限制用户一次最多只能同时生成 9 张图片的缩略图, 那 canvas 的尺寸可以固定设置为 50 x 450.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>canvas</span> <span class=\"token attr-name\">canvas-id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>canvas<span class=\"token punctuation\">\"</span></span><span class=\"token style-attr language-css\"><span class=\"token attr-name\"> <span class=\"token attr-name\">style</span></span><span class=\"token punctuation\">=\"</span><span class=\"token attr-value\"><span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 450px<span class=\"token punctuation\">;</span> <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 50px</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>canvas</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>可惜的是, 设置一个更大的 canvas, 最后通过 <code class=\"language-text\">wx.canvasToTempFilePath</code> 导出图片时, 至少 macOS 版的微信会把整个 canvas 导出, 而不是把 <code class=\"language-text\">wx.canvasToTempFilePath</code> 指定的 canvas 的某区域导出, 这应该是小程序的 bug.</p>\n<p>总结一下三种方法:</p>\n<ul>\n<li>设置一个小尺寸的固定大小的 canvas, 然后按顺序获取图片的缩略图, 缺点是有点慢;</li>\n<li>设置一个足够大的大尺寸的固定大小的 canvas, 先把所有图片 draw 进这个 canvas, 然后把不同的区域分别导出, 缺点是 PC 端似乎不能导出 canvas 的某个区域;</li>\n<li>根据收到的图片数量动态设置 canvas 的尺寸, 然后把 draw 函数写在 setData 的回调函数中, 并用 setTimeout 延迟这个 draw 函数, 缺点同上;</li>\n</ul>\n<p>这篇文章是关于小程序旧的 canvas api, 对于新的 api 即 canvas 2d, 如果没有在 query 之前设置 canvas 的 css 尺寸会导致 ios 端无法成功导出图片, 具体看我<a href=\"https://kejiweixun.com/blog/wechat-miniprogram-2d-canvas-drawImage-iOS-blank/\">之前的文章</a>.</p>","frontmatter":{"title":"小程序在一个 canvas 组件画多张图片并导出多张图片的问题","date":"2020/07/02","slug":"wechat-miniprogram-canvas-draw-and-export-multiple-images","description":null}}}]}},"pageContext":{"slug":"wechat-miniprogram-canvas-draw-and-export-multiple-images"}}}