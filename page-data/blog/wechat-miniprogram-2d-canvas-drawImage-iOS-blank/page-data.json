{"componentChunkName":"component---src-template-blog-post-template-js","path":"/blog/wechat-miniprogram-2d-canvas-drawImage-iOS-blank/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<p>我写了一段大概是下面这样的代码, 把图片 draw 在一个 canvas 上, 然后再把 canvas 导出成图片. canvas 的尺寸有两种, 分别是 <code class=\"language-text\">canvas.width</code> 和 \u001f<code class=\"language-text\">canvas.style.width</code>, 其中 <code class=\"language-text\">canvas.width</code> 我在 query 执行后的回调函数中设置, 而 <code class=\"language-text\">canvas.style.width</code> 我通过数据绑定的方式动态设置, 具体也是在 query 执行后的回调函数中设置.</p>\n<p>wxml</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>canvas</span>\n  <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>2d<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>canvas<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token style-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token style language-css\"><span class=\"token selector\">width:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>canvasSize.cssWidth<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>px<span class=\"token selector\">; height:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>canvasSize.cssHeight<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>px</span><span class=\"token punctuation\">\"</span></span></span>\n<span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>canvas</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>image</span>\n  <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>{{outputImage}}<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token style-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token style language-css\"><span class=\"token selector\">width:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>canvasSize.cssWidth<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>px<span class=\"token selector\">; height:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>canvasSize.cssHeight<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>px</span><span class=\"token punctuation\">\"</span></span></span>\n<span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>image</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  path<span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n  width<span class=\"token operator\">:</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span>\n  height<span class=\"token operator\">:</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> query <span class=\"token operator\">=</span> wx<span class=\"token punctuation\">.</span><span class=\"token function\">createSelectorQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nquery\n  <span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#canvas\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">fields</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> node<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> size<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">exec</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> canvas <span class=\"token operator\">=</span> res<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>node\n    <span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> canvas<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2d\"</span><span class=\"token punctuation\">)</span>\n    canvas<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> <span class=\"token number\">100</span>\n    canvas<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> <span class=\"token number\">100</span>\n    <span class=\"token keyword\">const</span> img <span class=\"token operator\">=</span> canvas<span class=\"token punctuation\">.</span><span class=\"token function\">createImage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    img<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> image<span class=\"token punctuation\">.</span>path\n    img<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        canvasSize<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          cssWidth<span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span>\n          cssHeight<span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      ctx<span class=\"token punctuation\">.</span><span class=\"token function\">drawImage</span><span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span>\n      wx<span class=\"token punctuation\">.</span><span class=\"token function\">canvasToTempFilePath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        canvas<span class=\"token operator\">:</span> canvas<span class=\"token punctuation\">,</span>\n        destWidth<span class=\"token operator\">:</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span>\n        destHeight<span class=\"token operator\">:</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function-variable function\">success</span><span class=\"token operator\">:</span> <span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            outputImage<span class=\"token operator\">:</span> res<span class=\"token punctuation\">.</span>tempFilePath<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>这样的代码可以在开发者工具以及 android 端正常运行, 即 <code class=\"language-text\">&lt;image&gt;</code> 组件可以成功显示通过 canvas 导出的图片, 但是 iOS 端不能, iOS 显示为空.</p>\n<p>解决方法是在 query 之前, 就应该设置好 <code class=\"language-text\">&lt;canvas&gt;</code> 的 css 尺寸, 即把下面这段代码移至 query 之前:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  canvasSize<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    cssWidth<span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span>\n    cssHeight<span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>如果不设置 canvas 的 css 尺寸, 那小程序会默认它是 300 x 150, 所以并不会出错.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>canvas</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>2d<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>canvas<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>canvas</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>更改 canvas 的 css 尺寸之后, 如果需要用到新尺寸的画布, 那都需要重新 query 一次这个 canvas, 如果使用修改尺寸之前 query 到的 ctx 去画图, 画出来的图片可能会变形. 修改 canvas 的尺寸之前, 最好 clear 一次画布, 这样在画布尺寸修改时可以避免画面的短暂变形.</p>","frontmatter":{"title":"iOS 小程序 2d canvas drawImage 结果是空的问题","date":"2020/06/29","slug":"wechat-miniprogram-2d-canvas-drawImage-iOS-blank","description":null}}}]}},"pageContext":{"slug":"wechat-miniprogram-2d-canvas-drawImage-iOS-blank"}},"staticQueryHashes":["1518281631"]}