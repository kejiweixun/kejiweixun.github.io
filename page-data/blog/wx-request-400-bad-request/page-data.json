{"componentChunkName":"component---src-template-blog-post-template-js","path":"/blog/wx-request-400-bad-request/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<p>我写的小程序 \"水果机大全\" 用了我自己搭建的一个 api, 使用 wx.request 从这个 api 请求数据, 竟然返回 <code class=\"language-text\">400 (Bad Request)</code>.</p>\n<p>官方给出的 wx.request 的使用方法是这样的:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">wx<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  url<span class=\"token punctuation\">:</span> <span class=\"token string\">\"some url\"</span><span class=\"token punctuation\">,</span>\n  data<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    x<span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    y<span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  header<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"content-type\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>搜了一下, 大部分小伙伴建议把 <code class=\"language-text\">&#39;application/json&#39;</code> 修改为 <code class=\"language-text\">&#39;json&#39;</code>, 我试了还是返回 <code class=\"language-text\">400</code>, 可能有人和我一样改了 json 还是不行, 所以分享一下我的方法.</p>\n<p>我登录 api 的服务器查了一下日志, 当我的小程序发出请求时, 服务器返回 <code class=\"language-text\">typeerror: invalid media type</code>, 看来确实是 <code class=\"language-text\">content-type</code> 设置不当造成的.</p>\n<p>我的 api 格式大概是 <code class=\"language-text\">https://api.kejiweixun.com/something?key=value</code>, 下面是我一开始请求数据的方式:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">wx<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  url<span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://api.kejiweixun.com/something?key=value\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>刚开始我没有写 <code class=\"language-text\">header</code>, 但因为 <code class=\"language-text\">&#39;content-type&#39;: &#39;application/json&#39;</code> 是默认值, 不设置 header 就默认采用这个值, 返回 400 说明 <code class=\"language-text\">application/json</code> 肯定不对.</p>\n<p>最后我改成了这样:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">wx<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  url<span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://api.kejiweixun.com/something\"</span><span class=\"token punctuation\">,</span>\n  data<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    x<span class=\"token punctuation\">:</span> <span class=\"token string\">\"key\"</span><span class=\"token punctuation\">,</span>\n    y<span class=\"token punctuation\">:</span> <span class=\"token string\">\"value\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  header<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"content-type\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"application/x-www-form-urlencoded\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>把 <code class=\"language-text\">?key=value</code> 挪到 <code class=\"language-text\">data</code> 中, 然后把 <code class=\"language-text\">content-type</code> 设置为 <code class=\"language-text\">application/x-www-form-urlencoded</code>, 其实设置为 <code class=\"language-text\">multipart/form-data</code> 也能正常请求数据, 但除非 <code class=\"language-text\">data</code> 是大体积的 binary data, 否则用前者更好.</p>","frontmatter":{"title":"微信小程序 wx.request 返回 400 bad request 解决方法","date":"2019/11/02","slug":"wx-request-400-bad-request","description":"看到很多人建议把 header 改为 json, 我试了不行, 后来改为 application/x-www-form-urlencoded 就可以了"}}}]}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"wx-request-400-bad-request"}}}