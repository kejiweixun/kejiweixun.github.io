{"componentChunkName":"component---src-template-blog-post-template-js","path":"/blog/about-wechat-miniprogram-2d-canvas-sizes/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<p>微信小程序 canvas 2d <a href=\"https://developers.weixin.qq.com/miniprogram/dev/component/canvas.html\">官方例子</a>是这样的:</p>\n<p>wxml</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>canvas</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>2d<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>myCanvas<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>canvas</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">Page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token function\">onReady</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> query <span class=\"token operator\">=</span> wx<span class=\"token punctuation\">.</span><span class=\"token function\">createSelectorQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    query\n      <span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#myCanvas\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">fields</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> node<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> size<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">exec</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> canvas <span class=\"token operator\">=</span> res<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>node\n        <span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> canvas<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2d\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// 根据 dpr 做相关设置</span>\n        <span class=\"token keyword\">const</span> dpr <span class=\"token operator\">=</span> wx<span class=\"token punctuation\">.</span><span class=\"token function\">getSystemInfoSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>devicePixelRatio\n        canvas<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> res<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>width <span class=\"token operator\">*</span> dpr\n        canvas<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> res<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>height <span class=\"token operator\">*</span> dpr\n\n        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">scale</span><span class=\"token punctuation\">(</span>dpr<span class=\"token punctuation\">,</span> dpr<span class=\"token punctuation\">)</span>\n        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">fillRect</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>canvas 组件没有设置 style, 所以默认 style 就是 <code class=\"language-text\">width: 300px; height 150px</code>, 在 wxml 中的尺寸都是 <code class=\"language-text\">css pixel</code>, 设备会把 css pixel 乘以 devicePixelRatio 转换成 device pixel 再显示在屏幕上. iPhone 6 的屏幕分辨率是 375*667, 这个数字也是 css pixel.</p>\n<p>记住, 在 wxml 显示的是 css pixel, 但是在 js 中写的 canvas 代码, 通常是 device pixel 尺寸. 所以上面的例子, 通过 <code class=\"language-text\">res[0].width</code> 拿到这个 canvas 组件的 css pixel, 然后乘以 dpr 转换成这个 canvas 的 device pixel. 如果不转换, 那整个图片都会被缩小.</p>\n<p><code class=\"language-text\">canvas.width</code> 和 <code class=\"language-text\">canvas.style.width</code> 是不同的东西, 前者定义了 canvas 的座标体系, 而后者定义 canvas 实际显示的尺寸. 上面这个例子设置了 <code class=\"language-text\">canvas.width = canvas.style.width * dpr</code>, 这样可以保证 canvas 的图片清晰地显示出来. 有时候也可以 <code class=\"language-text\">Math.round(canvas.width / dpr) = canvas.style.width</code></p>\n<p><code class=\"language-text\">ctx.scale(dpr, dpr)</code> 的作用是, 用微信小程序文档的<a href=\"https://developers.weixin.qq.com/miniprogram/dev/api/canvas/CanvasContext.scale.html\">一句话</a>来说, 就是:</p>\n<blockquote>\n<p>在调用后，之后创建的路径其横纵坐标会被缩放。多次调用倍数会相乘.</p>\n</blockquote>\n<p>所以下面这个代码:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">ctx<span class=\"token punctuation\">.</span><span class=\"token function\">scale</span><span class=\"token punctuation\">(</span>dpr<span class=\"token punctuation\">,</span> dpr<span class=\"token punctuation\">)</span>\nctx<span class=\"token punctuation\">.</span><span class=\"token function\">fillRect</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>相当于下面这个代码:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">ctx<span class=\"token punctuation\">.</span><span class=\"token function\">fillRect</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span> <span class=\"token operator\">*</span> dpr<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token operator\">*</span> dpr<span class=\"token punctuation\">,</span> <span class=\"token number\">100</span> <span class=\"token operator\">*</span> dpr<span class=\"token punctuation\">,</span> <span class=\"token number\">100</span> <span class=\"token operator\">*</span> dpr<span class=\"token punctuation\">)</span></code></pre></div>\n<p>有时候之所以写 <code class=\"language-text\">ctx.scale(dpr, dpr)</code>, 是因为接下来可以用 css pixel 去画这个 canvas, 毕竟 css pixel 是设计师采用的尺寸, 不用每次都乘以 dpr.</p>\n<p><code class=\"language-text\">drawImage(imageResource, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight)</code> 中, sWidth 和 sHeight 都是图片的 css pixel 尺寸, 如果不确定可以用 <code class=\"language-text\">wx.getImageInfo()</code> 获取, 后面四个参数都是 canvas 的座标位置, 根据 <code class=\"language-text\">canvas.width</code> 和 <code class=\"language-text\">canvas.height</code> 以及 <code class=\"language-text\">ctx.scale(dpr, dpr)</code> 确定.</p>\n<p><code class=\"language-text\">wx.canvasToTempFilePath</code> 可以设置这些选项:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">wx<span class=\"token punctuation\">.</span><span class=\"token function\">canvasToTempFilePath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  x<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  y<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  width<span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span>\n  height<span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span>\n  destWidth<span class=\"token operator\">:</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span>\n  destHeight<span class=\"token operator\">:</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span>\n  canvas<span class=\"token operator\">:</span> <span class=\"token string\">'myCanvas'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>tempFilePath<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>前面四个参数是 canvas 的 css 座标, destWidth 和 destHeight 是最终输出的图片的 css 尺寸, 即 <code class=\"language-text\">destWidth: 100,</code> 其实相当于在输出的图片添加 <code class=\"language-text\">image.style.width = 100px</code>. destWidth 和 destHeight 要不小于 width 和 height, 否则会变模糊.</p>","frontmatter":{"title":"小程序 2d canvas 尺寸问题","date":"2020/06/26","slug":"about-wechat-miniprogram-2d-canvas-sizes","description":null}}}]}},"pageContext":{"slug":"about-wechat-miniprogram-2d-canvas-sizes"}},"staticQueryHashes":["1518281631"]}